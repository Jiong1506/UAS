<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ujian Akhir Semester</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root {
      --bg: #111827;
      --card: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #6366f1;
      --success-clr: #10b981;
      --danger-clr: #ef4444;
    }

    html, body { 
      height: 100%; 
      overflow-x: hidden;
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      transition: background-color .25s, color .25s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      transition: background-color .25s, box-shadow .25s;
    }

    .btn {
      background: linear-gradient(90deg, var(--accent), #5b21b6);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform .1s, opacity .1s;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); opacity: 0.9;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--muted);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: color .25s, border-color .25s;
    }
    .btn-ghost:hover { color: var(--text);
    border-color: var(--text); }

    .sidebar-scroll { 
      scrollbar-width: thin; 
      scrollbar-color: rgba(255,255,255,0.12) transparent;
    }
    .sidebar-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 999px;
    }

    /* Default (Mobile Portrait) */
    .layout { 
      flex-direction: column;
      min-height: 100vh;
    }
    
    .main-header { 
      flex-direction: column;
      align-items: flex-start; 
      gap: 1rem; 
      margin-bottom: 1rem;
    }
    
    aside.sidebar { 
      width: 100%;
      flex-direction: column; 
      padding: 1rem; 
      overflow-x: hidden; 
      overflow-y: auto;
      max-height: 40vh;
    }
    
    aside.sidebar .logo-area { 
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    
    aside.sidebar .theme-toggle-area { 
      display: none;
    }
    
    aside.sidebar nav { 
      flex-direction: column;
      width: 100%;
    }
    
    aside.sidebar button { 
      width: 100%;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    
    .mobile-floating { 
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: var(--card);
      padding: 0.5rem;
      border-top: 1px solid var(--muted);
    }
    
    .exam-grid { 
      grid-template-columns: 1fr; 
      gap: 1rem;
    }
    
    .mobile-button-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 100%;
      margin-top: 1rem;
    }
    
    .mobile-button-group .btn {
      width: 100%;
      text-align: center;
    }

    /* Dashboard mobile improvements */
    #courses-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    @media (max-width: 575px) {
      #courses-grid .card {
        height: auto;
        min-height: 120px;
      }
      
      .course-preview {
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
      }
      
      .course-preview div {
        white-space: normal;
        font-size: 0.8rem;
        line-height: 1.2;
      }
    }
    
    @media (min-width: 576px) and (max-width: 899px) {
      .layout { flex-direction: row;
      }
      .main-header { flex-direction: row; align-items: center; gap: 1rem;
      }
      aside.sidebar { 
        width: 12rem; 
        min-width: 12rem;
        max-width: 12rem; 
        flex-direction: column; 
        padding: 1rem; 
        max-height: 100vh;
      }
      aside.sidebar .logo-area { display: flex;
      }
      aside.sidebar nav { flex-direction: column;
      }
      .mobile-floating { display: block;
      }
      .exam-grid { grid-template-columns: 1fr 1fr;
      }
      
      .mobile-button-group {
        flex-direction: row;
        justify-content: flex-end;
      }
      
      #courses-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Media Query: Tablet dan PC (lebar minimal 900px) */
    @media (min-width: 900px) {
      .layout { flex-direction: row;
      }
      .main-header { flex-direction: row; align-items: center; gap: 1rem;
      }
      aside.sidebar { 
        width: 18rem; 
        min-width: 18rem;
        flex-direction: column; 
        padding: 1.5rem; 
        max-height: 100vh;
      }
      aside.sidebar .logo-area { display: flex;
      }
      aside.sidebar nav { flex-direction: column;
      }
      .mobile-floating { display: none;
      }
      .exam-grid { grid-template-columns: 1fr 1fr 1fr;
      }
      
      .mobile-button-group {
        flex-direction: row;
        justify-content: flex-end;
      }
      
      #courses-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    select.dark-select {
        background-color: var(--card) !important;
        color: var(--text) !important;
        border-color: var(--muted) !important;
        width: 100%;
        max-width: 100%;
    }

    select.dark-select option {
        background-color: var(--card) !important;
        color: var(--text) !important;
    }

    input.dark-input, textarea.dark-input {
      background-color: var(--card) !important;
      color: var(--text) !important;
      border-color: var(--muted) !important;
      width: 100%;
      box-sizing: border-box;
    }

    .image-dropzone {
      background-color: var(--card);
      color: var(--text);
      border: 1px solid var(--muted);
      width: 100%;
      box-sizing: border-box;
    }
    
    .manage-controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
    }
    
    @media (min-width: 768px) {
      .manage-controls {
        flex-direction: row;
        align-items: flex-end;
      }
    }
    
    .file-upload-area {
      width: 100%;
      overflow: hidden;
    }
    
    .file-upload-area input[type="file"] {
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Perbaikan tampilan soal */
    .question-item {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .question-text {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .question-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    @media (min-width: 640px) {
      .question-options {
        grid-template-columns: 1fr 1fr;
      }
    }

    .question-option {
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .question-option span {
        font-weight: bold;
        text-decoration: underline;
        font-style: italic;
    }
    
    .correct-option {
      background-color: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.5);
    }
    
    .question-image {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 1rem;
      max-height: 200px;
      object-fit: contain;
    }
    
    .question-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      justify-content: flex-end;
    }
    
    .no-questions {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
      font-style: italic;
    }
    
    .course-preview {
      max-height: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .course-preview div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Pop-out styling */
    .popout-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(5px);
    }

    .popout-content {
      background-color: var(--bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.2s, opacity 0.2s;
    }

    .popout-content.show {
      transform: scale(1);
      opacity: 1;
    }
    
    /* Text editor styling */
    .ql-toolbar.ql-snow {
      border: 1px solid var(--muted) !important;
      background-color: var(--card) !important;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    
    .ql-container.ql-snow {
      border: 1px solid var(--muted) !important;
      background-color: var(--card) !important;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      color: var(--text) !important;
    }
    
    .ql-editor {
      color: var(--text) !important;
      min-height: 100px;
    }
    
    .ql-snow .ql-stroke {
      stroke: var(--text) !important;
    }
    
    .ql-snow .ql-fill {
      fill: var(--text) !important;
    }
    
    .ql-snow .ql-picker {
      color: var(--text) !important;
    }
    
    /* Improved exam sidebar */
    #exam-sidebar {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      padding: 0.5rem;
    }
    
    #exam-sidebar button {
      width: 100%;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    
    #exam-sidebar button:hover {
      transform: scale(1.05);
    }
    
    #exam-sidebar button.active {
      background-color: var(--accent);
      color: white;
    }
    
    /* Mobile number buttons */
    #mobile-numbers > div {
      display: flex;
      gap: 0.25rem;
      overflow-x: auto;
      padding: 0.25rem;
    }
    
    #mobile-numbers button {
      min-width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.875rem;
      background-color: rgba(255, 255, 255, 0.05);
      transition: all 0.2s;
    }
    
    #mobile-numbers button.active {
      background-color: var(--accent);
      color: white;
    }
  </style>
</head>
<body data-theme="dark">

<script>
  const SUPABASE_URL = 'https://znosqyapmdfujtqwdsdm.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpub3NxeWFwbWRmdWp0cXdkc2RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDE1MTIsImV4cCI6MjA3MzIxNzUxMn0.R-WmeGOY0LX0oJv-UhWloXfAFVyGrbTgBYF3X1cHeUk';
  const STORAGE_BUCKET = 'question-images';
</script>

<div id="app" class="min-h-screen layout flex">

  <aside class="sidebar card flex-shrink-0 flex flex-col gap-4">
    <div class="logo-area flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-gradient-to-br from-purple-600 to-indigo-600">
        <svg fill="white" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.31.31l5.112 2.125a.563.563 0 010 1.04l-5.111 2.125a.563.563 0 00-.31.31l-2.125 5.112a.563.563 0 01-1.04 0l-2.125-5.111a.563.563 0 00-.31-.31l-5.112-2.125a.563.563 0 010-1.04l5.111-2.125a.563.563 0 00.31-.31L11.48 3.5z" />
        </svg>
      </div>
      <div>
        <div class="font-semibold">Ujian Akhir Semester</div>
      </div>
    </div>

    <nav class="flex gap-2">
      <button id="nav-dashboard" class="text-left px-3 py-2 rounded-md bg-white/5">Dashboard</button>
      <button id="nav-create" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Buat Mata Kuliah</button>
      <button id="nav-manage" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Kelola Soal</button>
      <button id="nav-exam" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Jalankan Ujian</button>
    </nav>
  </aside>

  <main 
  class="flex-1 p-4 md:p-6 overflow-y-auto">
    <div class="main-header flex items-center justify-between mb-6">
      <div>
        <h1 id="page-title" class="text-2xl font-bold">Dashboard</h1>
        <p id="page-sub" class="text-sm muted">Ringkasan mata kuliah & soal</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="open-create" class="btn">Buat Mata Kuliah</button>
      </div>
    </div>

    <section id="dashboard-section">
      <div id="courses-grid" class="gap-4"></div>
    </section>

  
    <section id="create-section" class="hidden">
      <div class="card p-4">
        <h2 class="text-lg font-semibold">Buat Mata Kuliah</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm muted">Nama Mata Kuliah</label>
            <input id="course-name" class="mt-2 p-3 border rounded w-full bg-transparent dark-input" placeholder="Contoh: Basis Data" />
            <label 
            class="text-sm muted mt-3 block">Soal pertama (opsional)</label>
            <div id="text-editor-container" class="mt-2 border rounded overflow-hidden">
              <div id="text-editor-toolbar">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
            
              </div>
              <div id="text-editor" class="bg-transparent dark-input" style="min-height: 100px;"></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi A" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi B" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi C" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi D" />
            </div>
            <div class="flex items-center gap-2 mt-3">
            
              <select id="initial-key" class="p-2 border rounded bg-transparent muted dark-select">
                <option value="">Kunci (opsional)</option>
                <option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
              </select>
            </div>
          </div>
          <div>
       
            <label class="text-sm muted">Gambar (opsional)</label>
            <div id="drop-new" class="mt-2 p-3 border rounded flex flex-col items-center justify-center image-dropzone h-40">
              <div class="text-sm muted">Tarik & lepas atau pilih file</div>
              <input id="file-new" type="file" accept="image/*" class="hidden" />
              <div class="mt-3 flex gap-2">
            
                <button id="pick-new" class="px-3 py-2 rounded bg-indigo-600 text-white">Pilih Gambar</button>
                <button id="clear-new" class="px-3 py-2 rounded bg-white/10">Hapus</button>
              </div>
              <img id="preview-new" class="mt-3 max-h-28 rounded hidden" alt="preview" />
            </div>
          </div>
        </div>
   
        <div class="mt-4 flex justify-end gap-2">
          <button id="create-course" class="btn">Buat</button>
          <button id="cancel-create" class="btn-ghost">Batal</button>
        </div>
      </div>
    </section>

    <section id="manage-section" class="hidden">
      <div class="card p-4">
        <div class="flex items-center justify-between flex-col md:flex-row gap-4 md:gap-0">
          <div>
          
            <h2 class="text-lg font-semibold">Kelola Soal</h2>
            <p class="text-sm muted">Pilih mata kuliah lalu tambah/edit/hapus soal.</p>
          </div>
          <div class="manage-controls">
            <select id="select-manage" class="p-2 border rounded bg-transparent dark-select">
              <option value="">— Pilih Mata Kuliah —</option>
            </select>
      
            <button id="btn-add-q" class="px-3 py-2 bg-indigo-600 text-white rounded" disabled>Tambah Soal</button>
          </div>
        </div>
        <div id="questions-list" class="mt-4 space-y-3"></div>
      </div>
    </section>

    <div id="editor-popout" class="popout-backdrop hidden">
      <div class="popout-content">
        <div class="flex items-center justify-between">
          <h3 id="editor-title" class="text-lg font-semibold">Tambah Soal</h3>
        
          <div>
            <button id="editor-cancel" class="btn-ghost">Batal</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm muted">Teks Soal</label>
            <div id="qe-text-editor-container" class="border rounded overflow-hidden">
            
              <div id="qe-text-toolbar">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </div>
              <div id="qe-text" class="bg-transparent dark-input" style="min-height: 100px;"></div>
            </div>
 
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input id="qe-opt-0" class="p-2 border rounded dark-input" placeholder="Opsi A" />
              <input id="qe-opt-1" class="p-2 border rounded dark-input" placeholder="Opsi B" />
              <input id="qe-opt-2" class="p-2 border rounded dark-input" placeholder="Opsi C 
            (opsional)" />
              <input id="qe-opt-3" class="p-2 border rounded dark-input" placeholder="Opsi D (opsional)" />
            </div>
            <div class="flex items-center gap-2 mt-3">
              <select id="qe-key" class="p-2 border rounded bg-transparent dark-select">
                <option value="">— Pilih Kunci —</option><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
    
              </select>
            </div>
          </div>
          <div>
            <label class="text-sm muted">Gambar (opsional)</label>
            <div id="drop-q" class="mt-2 p-3 border rounded flex flex-col items-center justify-center image-dropzone h-44">
              <div class="text-sm muted">Tarik & lepas atau 
            pilih file</div>
              <input id="file-q" type="file" accept="image/*" class="hidden" />
              <div class="mt-3 flex gap-2">
                <button id="pick-q" class="px-3 py-2 rounded bg-indigo-600 text-white">Pilih</button>
                <button id="clear-q" class="px-3 py-2 rounded bg-white/10">Hapus</button>
              </div>
      
              <img id="preview-q" class="mt-3 max-h-28 rounded hidden" alt="preview" />
            </div>
          </div>
        </div>

        <div class="card p-4 mt-4 flex flex-col items-start gap-2">
          <h3 class="text-md font-semibold">Unggah Soal dari File Teks</h3>
          <p class="text-sm muted">Pilih mata kuliah lalu unggah file .txt.
            Lihat <a href="#" class="underline" onclick="alert('Format file:\n\nQ: Teks soal\nA: Opsi A\nB: Opsi B\nK: A\n\nSetiap soal dipisahkan oleh baris baru. Gambar tidak didukung.')">format file</a>.</p>
          <div class="file-upload-area">
            <input type="file" id="file-upload" accept=".txt" class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 bg-transparent text-white/90 w-full" />
          </div>
          <p id="upload-status" class="text-sm muted mt-2"></p>
        </div>
       
  
        <div class="mt-4 flex justify-end gap-2">
          <button id="save-q" class="btn">Simpan Soal</button>
        </div>
      </div>
    </div>
    <section id="exam-section" class="hidden mt-4">
      <div class="card p-4">
        <div class="flex items-center justify-between flex-col md:flex-row gap-4 md:gap-0">
          <div>
            <h2 class="text-lg font-semibold">Mode Ujian 
            — Tampilkan Semua Soal</h2>
            <p class="text-sm muted">Semua soal akan ditampilkan sekaligus (maks 50).
            Klik nomor di sidebar untuk lompat cepat.</p>
          </div>
          <div class="manage-controls">
            <select id="select-exam" class="p-2 border rounded bg-transparent dark-select">
              <option value="">— Pilih Mata Kuliah —</option>
            </select>
            <div class="mobile-button-group">
           
              <button id="start-exam" class="btn" disabled>Mulai Ujian</button>
              <button id="end-exam" class="btn hidden">Selesai Ujian</button>
            </div>
          </div>
        </div>
        <div id="exam-score-display" class="card p-4 my-4 hidden"></div>

        <div class="mt-4 flex flex-col md:flex-row gap-4">
          <aside id="exam-sidebar" class="hidden md:block w-full md:w-auto sidebar-scroll h-[70vh] overflow-y-auto 
            p-2 card"></aside>

          <div class="flex-1">
            <div class="flex items-center justify-between mb-3">
              <div class="small-muted">Progress</div>
              <div class="small-muted" id="progress-text">0 / 0 dijawab</div>
            </div>
            <div class="h-2 bg-white/5 rounded overflow-hidden mb-4">
         
              <div id="exam-progress" class="h-2 rounded" style="width:0%;
            background: linear-gradient(90deg,var(--accent), #5b21b6)"></div>
            </div>
            <div id="exam-grid" class="grid gap-4 max-h-[70vh] overflow-y-auto p-1 exam-grid"></div>
          </div>
        </div>

        <div id="mobile-numbers" class="mobile-floating">
          <div class="px-3 py-2 flex gap-1 overflow-x-auto"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
(async function(){
  const 
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: false } });

  // DOM refs
  const app = document.getElementById('app'); 
  const pageTitle = document.getElementById('page-title');
  const pageSub = document.getElementById('page-sub');
  
  // Section refs
  const sections = {
    dashboard: document.getElementById('dashboard-section'),
    create: document.getElementById('create-section'),
    manage: document.getElementById('manage-section'),
    exam: document.getElementById('exam-section')
  };
  // Pop-out refs
  const editorPopout = document.getElementById('editor-popout');
  const editorPopoutContent = editorPopout.querySelector('.popout-content');
  const editorTitle = document.getElementById('editor-title');
  const editorCancelBtn = document.getElementById('editor-cancel');
  const saveQBtn = document.getElementById('save-q'); 
  // Navigation buttons 
  const nav = { 
    dashboard: document.getElementById('nav-dashboard'), 
    create: document.getElementById('nav-create'), 
    manage: document.getElementById('nav-manage'), 
    exam: document.getElementById('nav-exam') 
  };
  function showSection(name){ 
    Object.values(sections).forEach(s => s.classList.add('hidden')); 
    sections[name].classList.remove('hidden'); 
    pageTitle.textContent = name === 'dashboard' ? 'Dashboard' : name === 'create' ?
    'Buat Mata Kuliah' : name === 'manage' ? 'Kelola Soal' : 'Mode Ujian'; 
    // Nav active 
    Object.values(nav).forEach(b => b.classList.remove('bg-white/5'));
    if(name === 'dashboard') nav.dashboard.classList.add('bg-white/5'); 
    if(name === 'create') nav.create.classList.add('bg-white/5'); 
    if(name === 'manage') nav.manage.classList.add('bg-white/5'); 
    if(name === 'exam') nav.exam.classList.add('bg-white/5'); 
  } 
  nav.dashboard.addEventListener('click', ()=> showSection('dashboard'));
  nav.create.addEventListener('click', ()=> showSection('create')); 
  nav.manage.addEventListener('click', ()=> showSection('manage')); 
  nav.exam.addEventListener('click', ()=> showSection('exam')); 
  document.getElementById('open-create').addEventListener('click', ()=> showSection('create')); 
  // Initialize text editors 
  let textEditor, qeTextEditor;
  function initTextEditors() { 
    // Text editor for create section 
    textEditor = new Quill('#text-editor', { theme: 'snow', modules: { toolbar: '#text-editor-toolbar' } });
    // Text editor for question editor popout 
    qeTextEditor = new Quill('#qe-text', { theme: 'snow', modules: { toolbar: '#qe-text-toolbar' } });
  } 
  // Initialize the app 
  function init() { 
    initTextEditors(); 
    loadCourses(); 
    populateSelects(); 
    setupEventListeners();
  } 
  // Load courses for dashboard 
  async function loadCourses() { 
    const { data, error } = await sb.from('courses').select('id, name, created_at').order('created_at', { ascending: false });
    if (error) { 
      console.error('Error loading courses:', error); 
      return; 
    } 
    const coursesGrid = document.getElementById('courses-grid'); 
    coursesGrid.innerHTML = '';
    if (data.length === 0) { 
      coursesGrid.innerHTML = ` <div class="card p-4 text-center"> <p class="muted">Belum ada mata kuliah.
      Klik "Buat Mata Kuliah" untuk membuat yang pertama.</p> </div> `; 
      return;
    } 
    data.forEach(course => { 
      const courseEl = document.createElement('div'); 
      courseEl.className = 'card p-4'; 
      courseEl.innerHTML = ` <div class="flex items-center justify-between"> <div> <h3 class="font-semibold">${course.name}</h3> <p class="text-sm muted">Dibuat: ${new Date(course.created_at).toLocaleDateString('id-ID')}</p> </div> <div class="flex gap-2"> <button class="btn-ghost view-course" data-id="${course.id}">Lihat</button> </div> </div> `; 
      coursesGrid.appendChild(courseEl); 
    });
    // Add event listeners to view buttons 
    document.querySelectorAll('.view-course').forEach(btn => { 
      btn.addEventListener('click', () => { 
        const courseId = btn.getAttribute('data-id'); 
        showSection('manage'); 
        document.getElementById('select-manage').value = courseId; 
        loadQuestions(courseId); 
        document.getElementById('btn-add-q').disabled = false; 
      }); 
    });
  } 
  // Populate dropdown selects 
  async function populateSelects() { 
    const { data, error } = await sb.from('courses').select('id, name').order('name');
    if (error) { 
      console.error('Error loading courses for selects:', error); 
      return; 
    } 
    const manageSelect = document.getElementById('select-manage'); 
    const examSelect = document.getElementById('select-exam');
    // Clear existing options except the first one 
    while (manageSelect.options.length > 1) manageSelect.remove(1); 
    while (examSelect.options.length > 1) examSelect.remove(1);
    data.forEach(course => { 
      const option = document.createElement('option'); 
      option.value = course.id; 
      option.textContent = course.name; 
      manageSelect.appendChild(option.cloneNode(true)); 
      examSelect.appendChild(option); 
    });
  } 
  // Setup event listeners 
  function setupEventListeners() { 
    // Create course 
    document.getElementById('create-course').addEventListener('click', createCourse); 
    document.getElementById('cancel-create').addEventListener('click', () => showSection('dashboard'));
    // Manage section 
    document.getElementById('select-manage').addEventListener('change', function() { 
      const courseId = this.value; 
      document.getElementById('btn-add-q').disabled = !courseId; 
      if (courseId) loadQuestions(courseId); 
      else document.getElementById('questions-list').innerHTML = ''; 
    });
    document.getElementById('btn-add-q').addEventListener('click', () => { 
      const courseId = document.getElementById('select-manage').value; 
      if (courseId) openQuestionEditor(null, courseId); 
    });
    // Exam section 
    document.getElementById('select-exam').addEventListener('change', function() { 
      document.getElementById('start-exam').disabled = !this.value; 
    }); 
    document.getElementById('start-exam').addEventListener('click', startExam); 
    document.getElementById('end-exam').addEventListener('click', endExam);
    // Editor popout 
    editorCancelBtn.addEventListener('click', () => { 
      editorPopout.classList.add('hidden'); 
    }); 
    saveQBtn.addEventListener('click', saveQuestion); 
    // File upload 
    document.getElementById('file-upload').addEventListener('change', handleFileUpload);
  } 
  // Create a new course 
  async function createCourse() { 
    const name = document.getElementById('course-name').value.trim();
    if (!name) { 
      alert('Nama mata kuliah harus diisi'); 
      return; 
    } 
    const { data, error } = await sb.from('courses').insert([{ name }]).select();
    if (error) { 
      console.error('Error creating course:', error); 
      alert('Gagal membuat mata kuliah'); 
      return; 
    } 
    const courseId = data[0].id;
    // If there's a question, add it 
    const questionText = textEditor.root.innerHTML; 
    const options = Array.from(document.querySelectorAll('.opt.init')).map(input => input.value.trim()).filter(v => v);
    const key = document.getElementById('initial-key').value; 
    if (questionText || options.length > 0) { 
      const questionData = { course_id: courseId, text: questionText, options: options, key: key ?
      parseInt(key) : null }; 
      // Handle image if any 
      const fileInput = document.getElementById('file-new');
      if (fileInput.files.length > 0) { 
        const file = fileInput.files[0]; 
        const fileName = `${Date.now()}-${file.name}`;
        const { error: uploadError } = await sb.storage.from(STORAGE_BUCKET).upload(fileName, file); 
        if (uploadError) { 
          console.error('Error uploading image:', uploadError);
        } else { 
          questionData.image = fileName; 
        } 
      } 
      const { error: qError } = await sb.from('questions').insert([questionData]);
      if (qError) { 
        console.error('Error adding initial question:', qError); 
      } 
    } 
    alert('Mata kuliah berhasil dibuat'); 
    document.getElementById('course-name').value = ''; 
    textEditor.setText('');
    document.querySelectorAll('.opt.init').forEach(input => input.value = ''); 
    document.getElementById('initial-key').value = ''; 
    document.getElementById('preview-new').classList.add('hidden'); 
    loadCourses(); 
    populateSelects(); 
    showSection('dashboard');
  } 
  // Load questions for a course 
  async function loadQuestions(courseId) { 
    const { data, error } = await sb.from('questions').select('*').eq('course_id', courseId).order('created_at');
    if (error) { 
      console.error('Error loading questions:', error); 
      return; 
    } 
    const questionsList = document.getElementById('questions-list'); 
    questionsList.innerHTML = '';
    if (data.length === 0) { 
      questionsList.innerHTML = `<div class="no-questions">Belum ada soal untuk mata kuliah ini.</div>`; 
      return; 
    }
    data.forEach(q => { 
      const qEl = document.createElement('div'); 
      qEl.className = 'question-item card'; 
      qEl.innerHTML = ` 
        <div class="flex items-start gap-4"> 
          <div class="flex-1"> 
            <div class="question-text">${q.text}</div> 
            <div class="question-options"> 
              ${q.options.map(opt => `<div class="question-option"><span>${opt}</span></div>`).join('')} 
            </div> 
          </div> 
          ${q.image ? `<img src="${sb.storage.from(STORAGE_BUCKET).getPublicUrl(q.image).data.publicUrl}" alt="Question Image" class="question-image w-full h-auto" />` : ''} 
        </div> 
        <div class="question-actions"> 
          <button class="btn-ghost" onclick="editQuestion('${q.id}')">Edit</button> 
          <button class="btn-ghost" onclick="deleteQuestion('${q.id}')">Hapus</button> 
        </div> 
      `; 
      questionsList.appendChild(qEl); 
    }); 
  }
  // Open editor popout with data 
  let currentQuestionId = null; 
  async function openQuestionEditor(id, courseId) { 
    currentQuestionId = id; 
    editorTitle.textContent = id ? 'Edit Soal' : 'Tambah Soal'; 
    editorPopout.classList.remove('hidden'); 
    qeTextEditor.setText(''); 
    document.getElementById('qe-opt-0').value = ''; 
    document.getElementById('qe-opt-1').value = ''; 
    document.getElementById('qe-opt-2').value = ''; 
    document.getElementById('qe-opt-3').value = ''; 
    document.getElementById('qe-key').value = ''; 
    document.getElementById('preview-q').classList.add('hidden'); 
    document.getElementById('qe-key').innerHTML = ` 
      <option value="">— Pilih Kunci —</option> 
      <option value="0">A</option> 
      <option value="1">B</option> 
      <option value="2">C</option> 
      <option value="3">D</option> 
    `;
    if (id) { 
      const { data, error } = await sb.from('questions').select('*').eq('id', id).single(); 
      if (error) { 
        console.error('Error fetching question:', error); 
        return; 
      } 
      qeTextEditor.root.innerHTML = data.text; 
      data.options.forEach((opt, i) => { 
        document.getElementById(`qe-opt-${i}`).value = opt; 
      }); 
      document.getElementById('qe-key').value = data.key; 
      if (data.image) { 
        document.getElementById('preview-q').src = sb.storage.from(STORAGE_BUCKET).getPublicUrl(data.image).data.publicUrl; 
        document.getElementById('preview-q').classList.remove('hidden'); 
      } 
    } 
  }
  // Save or update a question 
  async function saveQuestion() { 
    const courseId = document.getElementById('select-manage').value; 
    const text = qeTextEditor.root.innerHTML; 
    const options = [ 
      document.getElementById('qe-opt-0').value.trim(), 
      document.getElementById('qe-opt-1').value.trim(), 
      document.getElementById('qe-opt-2').value.trim(), 
      document.getElementById('qe-opt-3').value.trim() 
    ].filter(v => v); 
    const key = document.getElementById('qe-key').value;
    if (!text || options.length < 2) { 
      alert('Teks soal dan minimal 2 opsi harus diisi'); 
      return; 
    } 
    const questionData = { course_id: courseId, text: text, options: options, key: key ? parseInt(key) : null };
    const fileInput = document.getElementById('file-q'); 
    if (fileInput.files.length > 0) { 
      const file = fileInput.files[0]; 
      const fileName = `${Date.now()}-${file.name}`; 
      const { error: uploadError } = await sb.storage.from(STORAGE_BUCKET).upload(fileName, file); 
      if (uploadError) { 
        console.error('Error uploading image:', uploadError); 
      } else { 
        questionData.image = fileName; 
      } 
    }
    if (currentQuestionId) { 
      const { error } = await sb.from('questions').update(questionData).eq('id', currentQuestionId); 
      if (error) console.error('Error updating question:', error); 
    } else { 
      const { error } = await sb.from('questions').insert([questionData]); 
      if (error) console.error('Error saving question:', error); 
    } 
    editorPopout.classList.add('hidden'); 
    loadQuestions(courseId); 
  }
  // Delete a question 
  async function deleteQuestion(id) { 
    if (!confirm('Yakin ingin menghapus soal ini?')) return; 
    const { error } = await sb.from('questions').delete().eq('id', id); 
    if (error) { 
      console.error('Error deleting question:', error); 
      return; 
    } 
    loadQuestions(document.getElementById('select-manage').value); 
  }
  // File upload from text file 
  async function handleFileUpload(event) { 
    const file = event.target.files[0]; 
    if (!file) return; 
    const reader = new FileReader(); 
    reader.onload = async function(e) { 
      const text = e.target.result; 
      const questions = parseTextToQuestions(text); 
      const courseId = document.getElementById('select-manage').value; 
      if (!courseId) { 
        alert('Pilih mata kuliah terlebih dahulu'); 
        return; 
      } 
      const { error } = await sb.from('questions').insert(questions.map(q => ({ ...q, course_id: courseId }))); 
      if (error) { 
        console.error('Error uploading questions:', error); 
        document.getElementById('upload-status').textContent = 'Gagal mengunggah soal.'; 
      } else { 
        document.getElementById('upload-status').textContent = 'Soal berhasil diunggah!'; 
        loadQuestions(courseId); 
      } 
    }; 
    reader.readAsText(file); 
  }
  // Parse text file to questions 
  function parseTextToQuestions(text) { 
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0); 
    const questions = []; 
    let currentQuestion = null; 
    lines.forEach(line => { 
      if (line.startsWith('Q:')) { 
        if (currentQuestion) questions.push(currentQuestion); 
        currentQuestion = { text: line.substring(2).trim(), options: [], key: null }; 
      } else if (line.startsWith('A:')) { 
        currentQuestion.options[0] = line.substring(2).trim(); 
      } else if (line.startsWith('B:')) { 
        currentQuestion.options[1] = line.substring(2).trim(); 
      } else if (line.startsWith('C:')) { 
        currentQuestion.options[2] = line.substring(2).trim(); 
      } else if (line.startsWith('D:')) { 
        currentQuestion.options[3] = line.substring(2).trim(); 
      } else if (line.startsWith('K:')) { 
        const keyMap = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 }; 
        currentQuestion.key = keyMap[line.substring(2).trim().toUpperCase()]; 
      } 
    }); 
    if (currentQuestion) questions.push(currentQuestion); 
    return questions; 
  }
  // Exam functions 
  async function startExam() { 
    const courseId = document.getElementById('select-exam').value; 
    if (!courseId) return; 
    const { data, error } = await sb.from('questions').select('*').eq('course_id', courseId).order('created_at').limit(50);
    if (error) { 
      console.error('Error fetching exam questions:', error); 
      return; 
    }
    if (data.length === 0) { 
      alert('Tidak ada soal untuk ujian ini.'); 
      return; 
    } 
    window.examData = { 
      questions: data, 
      answers: Array(data.length).fill(null), 
      questionsEl: document.getElementById('exam-grid'), 
      sidebarEl: document.getElementById('exam-sidebar'), 
      mobileNumbersEl: document.getElementById('mobile-numbers').querySelector('div') 
    }; 
    window.examData.questionsEl.innerHTML = ''; 
    window.examData.sidebarEl.innerHTML = ''; 
    window.examData.mobileNumbersEl.innerHTML = ''; 
    document.getElementById('start-exam').classList.add('hidden'); 
    document.getElementById('end-exam').classList.remove('hidden'); 
    document.getElementById('exam-score-display').classList.add('hidden');
    renderExamQuestions(); 
  }
  function renderExamQuestions() { 
    window.examData.questionsEl.innerHTML = ''; 
    window.examData.sidebarEl.innerHTML = ''; 
    window.examData.mobileNumbersEl.innerHTML = '';
    window.examData.questions.forEach((q, index) => { 
      const questionId = `question-${index}`;
      const qEl = document.createElement('div'); 
      qEl.className = 'question-item card'; 
      qEl.id = questionId; 
      qEl.innerHTML = ` 
        <div class="flex items-start gap-4"> 
          <div class="flex-1"> 
            <div class="question-text">${index + 1}. ${q.text}</div> 
            ${q.image ? `<img src="${sb.storage.from(STORAGE_BUCKET).getPublicUrl(q.image).data.publicUrl}" alt="Question Image" class="question-image" />` : ''} 
            <div class="question-options"> 
              ${q.options.map((opt, i) => `
                <label class="question-option flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="q-${index}" value="${i}" ${window.examData.answers[index] === i ? 'checked' : ''}>
                  <span>${opt}</span>
                </label>
              `).join('')} 
            </div> 
          </div> 
        </div> 
      `; 
      qEl.querySelectorAll('input[type="radio"]').forEach(input => { 
        input.addEventListener('change', (e) => handleAnswerChange(index, e.target.value)); 
      }); 
      window.examData.questionsEl.appendChild(qEl);
      // Create sidebar button 
      const sidebarBtn = document.createElement('button'); 
      sidebarBtn.textContent = index + 1; 
      sidebarBtn.dataset.questionId = questionId; 
      sidebarBtn.addEventListener('click', () => {
          document.getElementById(sidebarBtn.dataset.questionId).scrollIntoView({ behavior: 'smooth' });
          updateSidebarState();
      });
      if (window.examData.answers[index] !== null) {
          sidebarBtn.classList.add('active');
      }
      window.examData.sidebarEl.appendChild(sidebarBtn);
      
      // Create mobile button
      const mobileBtn = document.createElement('button');
      mobileBtn.textContent = index + 1;
      mobileBtn.dataset.questionId = questionId;
      mobileBtn.addEventListener('click', () => {
          document.getElementById(mobileBtn.dataset.questionId).scrollIntoView({ behavior: 'smooth' });
          updateSidebarState();
      });
      if (window.examData.answers[index] !== null) {
          mobileBtn.classList.add('active');
      }
      window.examData.mobileNumbersEl.appendChild(mobileBtn);
    });
    updateProgress();
  }
  function handleAnswerChange(questionIndex, optionIndex) { 
    window.examData.answers[questionIndex] = parseInt(optionIndex); 
    updateProgress(); 
    updateSidebarState();
  }
  function updateSidebarState() {
      window.examData.questions.forEach((q, index) => {
          const sidebarBtn = window.examData.sidebarEl.children[index];
          const mobileBtn = window.examData.mobileNumbersEl.children[index];
          if (window.examData.answers[index] !== null) {
              if (sidebarBtn) sidebarBtn.classList.add('active');
              if (mobileBtn) mobileBtn.classList.add('active');
          } else {
              if (sidebarBtn) sidebarBtn.classList.remove('active');
              if (mobileBtn) mobileBtn.classList.remove('active');
          }
      });
  }
  function updateProgress() { 
    const answered = window.examData.answers.filter(a => a !== null).length; 
    const total = window.examData.questions.length; 
    document.getElementById('progress-text').textContent = `${answered} / ${total} dijawab`; 
    document.getElementById('exam-progress').style.width = `${(answered / total) * 100}%`; 
  }
  // End exam and show results 
  async function endExam() { 
    let score = 0; 
    window.examData.questions.forEach((q, index) => { 
      if (window.examData.answers[index] === q.key) { 
        score++; 
      } 
    }); 
    const total = window.examData.questions.length; 
    const percentage = Math.round((score / total) * 100); 
    // Show score 
    const scoreDisplay = document.getElementById('exam-score-display'); 
    scoreDisplay.classList.remove('hidden'); 
    scoreDisplay.innerHTML = ` 
      <h3 class=\"text-lg font-semibold\">Hasil Ujian</h3> 
      <div class=\"mt-2 text-3xl font-bold\">${score} / ${total}</div> 
      <div class=\"mt-1 text-sm muted\">${percentage}% benar</div> 
      <div class=\"mt-3 h-3 bg-white/5 rounded overflow-hidden\">\r\n        <div class=\"h-3 rounded\" style=\"width: ${percentage}%; background: linear-gradient(90deg,var(--accent), #5b21b6)\"></div>\r\n      </div>\r\n    `; 
    const questionItems = document.querySelectorAll('#exam-grid .question-item'); 
    questionItems.forEach((item, index) => { 
      const q = window.examData.questions[index]; 
      const answered = window.examData.answers[index]; 
      const options = item.querySelectorAll('.question-option'); 
      options.forEach((opt, i) => { 
        opt.classList.remove('correct-option'); 
        if (i === q.key) { 
          opt.classList.add('correct-option'); 
        } 
        if (i === answered && i !== q.key) { 
          opt.style.backgroundColor = 'rgba(239, 68, 68, 0.2)'; 
          opt.style.borderColor = 'rgba(239, 68, 68, 0.5)'; 
        } 
      }); 
      // Disable radio buttons 
      item.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true); 
    });
    // Hide exam buttons 
    document.getElementById('end-exam').classList.add('hidden'); 
    document.getElementById('start-exam').classList.remove('hidden'); 
    document.getElementById('start-exam').textContent = 'Mulai Ulang';
  }
  // Image drag and drop 
  function setupImageDropzone(dropzoneId, fileInputId, previewId, clearBtnId) { 
    const dropzone = document.getElementById(dropzoneId); 
    const fileInput = document.getElementById(fileInputId); 
    const preview = document.getElementById(previewId); 
    const clearBtn = document.getElementById(clearBtnId);
    dropzone.addEventListener('dragover', (e) => { 
      e.preventDefault(); 
      dropzone.classList.add('border-indigo-500', 'bg-white/10'); 
    }); 
    dropzone.addEventListener('dragleave', () => { 
      dropzone.classList.remove('border-indigo-500', 'bg-white/10'); 
    }); 
    dropzone.addEventListener('drop', (e) => { 
      e.preventDefault(); 
      dropzone.classList.remove('border-indigo-500', 'bg-white/10'); 
      fileInput.files = e.dataTransfer.files; 
      handleFile(fileInput.files[0], preview); 
    }); 
    document.getElementById(`pick-${dropzoneId.split('-')[1]}`).addEventListener('click', () => fileInput.click()); 
    fileInput.addEventListener('change', () => { 
      handleFile(fileInput.files[0], preview); 
    }); 
    clearBtn.addEventListener('click', (e) => { 
      e.preventDefault(); 
      fileInput.value = ''; 
      preview.src = ''; 
      preview.classList.add('hidden'); 
    }); 
  }
  function handleFile(file, preview) { 
    if (file && file.type.startsWith('image/')) { 
      const reader = new FileReader(); 
      reader.onload = (e) => { 
        preview.src = e.target.result; 
        preview.classList.remove('hidden'); 
      }; 
      reader.readAsDataURL(file); 
    } 
  }
  document.addEventListener('DOMContentLoaded', () => {
    init();
    setupImageDropzone('drop-new', 'file-new', 'preview-new', 'clear-new'); 
    setupImageDropzone('drop-q', 'file-q', 'preview-q', 'clear-q'); 
  }); 
})();
</script>
</body>
</html>
