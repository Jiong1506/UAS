<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ujian Akhir Semester</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --bg: #111827;
      --card: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #6366f1;
      --success-clr: #10b981;
      --danger-clr: #ef4444;
    }

    html, body { 
      height: 100%; 
      overflow-x: hidden;
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      transition: background-color .25s, color .25s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      transition: background-color .25s, box-shadow .25s;
    }

    .btn {
      background: linear-gradient(90deg, var(--accent), #5b21b6);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform .1s, opacity .1s;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); opacity: 0.9; }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--muted);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: color .25s, border-color .25s;
    }
    .btn-ghost:hover { color: var(--text); border-color: var(--text); }

    .sidebar-scroll { 
      scrollbar-width: thin; 
      scrollbar-color: rgba(255,255,255,0.12) transparent;
    }
    .sidebar-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 999px; }

    /* Default (Mobile Portrait) */
    .layout { 
      flex-direction: column;
      min-height: 100vh;
    }
    
    .main-header { 
      flex-direction: column;
      align-items: flex-start; 
      gap: 1rem; 
      margin-bottom: 1rem;
    }
    
    aside.sidebar { 
      width: 100%;
      flex-direction: column; 
      padding: 1rem; 
      overflow-x: hidden; 
      overflow-y: auto;
      max-height: 40vh;
    }
    
    aside.sidebar .logo-area { 
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    
    aside.sidebar .theme-toggle-area { 
      display: none;
    }
    
    aside.sidebar nav { 
      flex-direction: column;
      width: 100%;
    }
    
    aside.sidebar button { 
      width: 100%;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    
    .mobile-floating { 
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: var(--card);
      padding: 0.5rem;
      border-top: 1px solid var(--muted);
    }
    
    .exam-grid { 
      grid-template-columns: 1fr; 
      gap: 1rem;
    }
    
    .mobile-button-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 100%;
      margin-top: 1rem;
    }
    
    .mobile-button-group .btn {
      width: 100%;
      text-align: center;
    }

    /* Media Query: Mobile Landscape (lebar minimal 576px) */
    @media (min-width: 576px) and (max-width: 899px) {
      .layout { flex-direction: row; }
      .main-header { flex-direction: row; align-items: center; gap: 1rem; }
      aside.sidebar { 
        width: 12rem; 
        min-width: 12rem;
        max-width: 12rem; 
        flex-direction: column; 
        padding: 1rem; 
        max-height: 100vh;
      }
      aside.sidebar .logo-area { display: flex; }
      aside.sidebar nav { flex-direction: column; }
      .mobile-floating { display: block; }
      .exam-grid { grid-template-columns: 1fr 1fr; }
      
      .mobile-button-group {
        flex-direction: row;
        justify-content: flex-end;
      }
    }

    /* Media Query: Tablet dan PC (lebar minimal 900px) */
    @media (min-width: 900px) {
      .layout { flex-direction: row; }
      .main-header { flex-direction: row; align-items: center; gap: 1rem; }
      aside.sidebar { 
        width: 18rem; 
        min-width: 18rem;
        flex-direction: column; 
        padding: 1.5rem; 
        max-height: 100vh;
      }
      aside.sidebar .logo-area { display: flex; }
      aside.sidebar nav { flex-direction: column; }
      .mobile-floating { display: none; }
      .exam-grid { grid-template-columns: 1fr 1fr 1fr; }
      
      .mobile-button-group {
        flex-direction: row;
        justify-content: flex-end;
      }
    }

    select.dark-select {
        background-color: var(--card) !important;
        color: var(--text) !important;
        border-color: var(--muted) !important;
        width: 100%;
        max-width: 100%;
    }

    select.dark-select option {
        background-color: var(--card) !important;
        color: var(--text) !important;
    }

    input.dark-input, textarea.dark-input {
      background-color: var(--card) !important;
      color: var(--text) !important;
      border-color: var(--muted) !important;
      width: 100%;
      box-sizing: border-box;
    }

    .image-dropzone {
      background-color: var(--card);
      color: var(--text);
      border: 1px solid var(--muted);
      width: 100%;
      box-sizing: border-box;
    }
    
    #courses-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    @media (min-width: 640px) {
      #courses-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (min-width: 1024px) {
      #courses-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .manage-controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
    }
    
    @media (min-width: 768px) {
      .manage-controls {
        flex-direction: row;
        align-items: flex-end;
      }
    }
    
    .file-upload-area {
      width: 100%;
      overflow: hidden;
    }
    
    .file-upload-area input[type="file"] {
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Perbaikan tampilan soal */
    .question-item {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .question-text {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .question-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    @media (min-width: 640px) {
      .question-options {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .question-option {
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .correct-option {
      background-color: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.5);
    }
    
    .question-image {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 1rem;
      max-height: 200px;
      object-fit: contain;
    }
    
    .question-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      justify-content: flex-end;
    }
    
    .no-questions {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
      font-style: italic;
    }
    
    .course-preview {
      max-height: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .course-preview div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Pop-out styling */
    .popout-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(5px);
    }

    .popout-content {
      background-color: var(--bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.2s, opacity 0.2s;
    }

    .popout-content.show {
      transform: scale(1);
      opacity: 1;
    }
  </style>
</head>
<body data-theme="dark">

<script>
  const SUPABASE_URL = 'https://znosqyapmdfujtqwdsdm.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpub3NxeWFwbWRmdWp0cXdkc2RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDE1MTIsImV4cCI6MjA3MzIxNzUxMn0.R-WmeGOY0LX0oJv-UhWloXfAFVyGrbTgBYF3X1cHeUk';
  const STORAGE_BUCKET = 'question-images';
</script>

<div id="app" class="min-h-screen layout flex">

  <aside class="sidebar card flex-shrink-0 flex flex-col gap-4">
    <div class="logo-area flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-gradient-to-br from-purple-600 to-indigo-600">
        <svg fill="white" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.31.31l5.112 2.125a.563.563 0 010 1.04l-5.111 2.125a.563.563 0 00-.31.31l-2.125 5.112a.563.563 0 01-1.04 0l-2.125-5.111a.563.563 0 00-.31-.31l-5.112-2.125a.563.563 0 010-1.04l5.111-2.125a.563.563 0 00.31-.31L11.48 3.5z" />
        </svg>
      </div>
      <div>
        <div class="font-semibold">Ujian Akhir Semester</div>
      </div>
    </div>

    <nav class="flex gap-2">
      <button id="nav-dashboard" class="text-left px-3 py-2 rounded-md bg-white/5">Dashboard</button>
      <button id="nav-create" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Buat Mata Kuliah</button>
      <button id="nav-manage" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Kelola Soal</button>
      <button id="nav-exam" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Jalankan Ujian</button>
    </nav>
  </aside>

  <main class="flex-1 p-4 md:p-6 overflow-y-auto">
    <div class="main-header flex items-center justify-between mb-6">
      <div>
        <h1 id="page-title" class="text-2xl font-bold">Dashboard</h1>
        <p id="page-sub" class="text-sm muted">Ringkasan mata kuliah & soal</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="open-create" class="btn">Buat Mata Kuliah</button>
      </div>
    </div>

    <section id="dashboard-section">
      <div id="courses-grid" class="gap-4"></div>
    </section>

    <section id="create-section" class="hidden">
      <div class="card p-4">
        <h2 class="text-lg font-semibold">Buat Mata Kuliah</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm muted">Nama Mata Kuliah</label>
            <input id="course-name" class="mt-2 p-3 border rounded w-full bg-transparent dark-input" placeholder="Contoh: Basis Data" />
            <label class="text-sm muted mt-3 block">Soal pertama (opsional)</label>
            <textarea id="initial-question" class="mt-2 p-3 border rounded w-full bg-transparent dark-input" placeholder="Teks soal (opsional)"></textarea>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi A" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi B" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi C" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi D" />
            </div>
            <div class="flex items-center gap-2 mt-3">
              <select id="initial-key" class="p-2 border rounded bg-transparent muted dark-select">
                <option value="">Kunci (opsional)</option>
                <option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-sm muted">Gambar (opsional)</label>
            <div id="drop-new" class="mt-2 p-3 border rounded flex flex-col items-center justify-center image-dropzone h-40">
              <div class="text-sm muted">Tarik & lepas atau pilih file</div>
              <input id="file-new" type="file" accept="image/*" class="hidden" />
              <div class="mt-3 flex gap-2">
                <button id="pick-new" class="px-3 py-2 rounded bg-indigo-600 text-white">Pilih Gambar</button>
                <button id="clear-new" class="px-3 py-2 rounded bg-white/10">Hapus</button>
              </div>
              <img id="preview-new" class="mt-3 max-h-28 rounded hidden" alt="preview" />
            </div>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="create-course" class="btn">Buat</button>
          <button id="cancel-create" class="btn-ghost">Batal</button>
        </div>
      </div>
    </section>

    <section id="manage-section" class="hidden">
      <div class="card p-4">
        <div class="flex items-center justify-between flex-col md:flex-row gap-4 md:gap-0">
          <div>
            <h2 class="text-lg font-semibold">Kelola Soal</h2>
            <p class="text-sm muted">Pilih mata kuliah lalu tambah/edit/hapus soal.</p>
          </div>
          <div class="manage-controls">
            <select id="select-manage" class="p-2 border rounded bg-transparent dark-select">
              <option value="">— Pilih Mata Kuliah —</option>
            </select>
            <button id="btn-add-q" class="px-3 py-2 bg-indigo-600 text-white rounded" disabled>Tambah Soal</button>
          </div>
        </div>
        <div id="questions-list" class="mt-4 space-y-3"></div>
      </div>
    </section>

    <div id="editor-popout" class="popout-backdrop hidden">
      <div class="popout-content">
        <div class="flex items-center justify-between">
          <h3 id="editor-title" class="text-lg font-semibold">Tambah Soal</h3>
          <div>
            <button id="editor-cancel" class="btn-ghost">Batal</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm muted">Teks Soal</label>
            <textarea id="qe-text" class="mt-2 p-3 border rounded w-full bg-transparent dark-input"></textarea>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input id="qe-opt-0" class="p-2 border rounded dark-input" placeholder="Opsi A" />
              <input id="qe-opt-1" class="p-2 border rounded dark-input" placeholder="Opsi B" />
              <input id="qe-opt-2" class="p-2 border rounded dark-input" placeholder="Opsi C (opsional)" />
              <input id="qe-opt-3" class="p-2 border rounded dark-input" placeholder="Opsi D (opsional)" />
            </div>
            <div class="flex items-center gap-2 mt-3">
              <select id="qe-key" class="p-2 border rounded bg-transparent dark-select">
                <option value="">— Pilih Kunci —</option><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-sm muted">Gambar (opsional)</label>
            <div id="drop-q" class="mt-2 p-3 border rounded flex flex-col items-center justify-center image-dropzone h-44">
              <div class="text-sm muted">Tarik & lepas atau pilih file</div>
              <input id="file-q" type="file" accept="image/*" class="hidden" />
              <div class="mt-3 flex gap-2">
                <button id="pick-q" class="px-3 py-2 rounded bg-indigo-600 text-white">Pilih</button>
                <button id="clear-q" class="px-3 py-2 rounded bg-white/10">Hapus</button>
              </div>
              <img id="preview-q" class="mt-3 max-h-28 rounded hidden" alt="preview" />
            </div>
          </div>
        </div>

        <div class="card p-4 mt-4 flex flex-col items-start gap-2">
          <h3 class="text-md font-semibold">Unggah Soal dari File Teks</h3>
          <p class="text-sm muted">Pilih mata kuliah lalu unggah file .txt. Lihat <a href="#" class="underline" onclick="alert('Format file:\n\nQ: Teks soal\nA: Opsi A\nB: Opsi B\nK: A\n\nSetiap soal dipisahkan oleh baris baru. Gambar tidak didukung.')">format file</a>.</p>
          <div class="file-upload-area">
            <input type="file" id="file-upload" accept=".txt" class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 bg-transparent text-white/90 w-full" />
          </div>
          <p id="upload-status" class="text-sm muted mt-2"></p>
        </div>
        
        <div class="mt-4 flex justify-end gap-2">
          <button id="save-q" class="btn">Simpan Soal</button>
        </div>
      </div>
    </div>
    <section id="exam-section" class="hidden mt-4">
      <div class="card p-4">
        <div class="flex items-center justify-between flex-col md:flex-row gap-4 md:gap-0">
          <div>
            <h2 class="text-lg font-semibold">Mode Ujian — Tampilkan Semua Soal</h2>
            <p class="text-sm muted">Semua soal akan ditampilkan sekaligus (maks 50). Klik nomor di sidebar untuk lompat cepat.</p>
          </div>
          <div class="manage-controls">
            <select id="select-exam" class="p-2 border rounded bg-transparent dark-select">
              <option value="">— Pilih Mata Kuliah —</option>
            </select>
            <div class="mobile-button-group">
              <button id="start-exam" class="btn" disabled>Mulai Ujian</button>
              <button id="end-exam" class="btn hidden">Selesai Ujian</button>
            </div>
          </div>
        </div>
        <div id="exam-score-display" class="card p-4 my-4 hidden"></div>

        <div class="mt-4 flex flex-col md:flex-row gap-4">
          <aside id="exam-sidebar" class="hidden md:block w-16 sidebar-scroll h-[70vh] overflow-y-auto p-2 card"></aside>

          <div class="flex-1">
            <div class="flex items-center justify-between mb-3">
              <div class="small-muted">Progress</div>
              <div class="small-muted" id="progress-text">0 / 0 dijawab</div>
            </div>
            <div class="h-2 bg-white/5 rounded overflow-hidden mb-4">
              <div id="exam-progress" class="h-2 rounded" style="width:0%; background: linear-gradient(90deg,var(--accent), #5b21b6)"></div>
            </div>
            <div id="exam-grid" class="grid gap-4 max-h-[70vh] overflow-y-auto p-1 exam-grid"></div>
          </div>
        </div>

        <div id="mobile-numbers" class="mobile-floating">
          <div class="px-3 py-2 flex gap-1 overflow-x-auto"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
(async function(){
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: false } });

  // DOM refs
  const app = document.getElementById('app'); 
  const pageTitle = document.getElementById('page-title');
  const pageSub = document.getElementById('page-sub');
  
  // Section refs
  const sections = {
    dashboard: document.getElementById('dashboard-section'),
    create: document.getElementById('create-section'),
    manage: document.getElementById('manage-section'),
    exam: document.getElementById('exam-section')
  };
  
  // Pop-out refs
  const editorPopout = document.getElementById('editor-popout');
  const editorPopoutContent = editorPopout.querySelector('.popout-content');
  const editorTitle = document.getElementById('editor-title');
  const editorCancelBtn = document.getElementById('editor-cancel');
  const saveQBtn = document.getElementById('save-q');

  // Navigation buttons
  const nav = {
    dashboard: document.getElementById('nav-dashboard'),
    create: document.getElementById('nav-create'),
    manage: document.getElementById('nav-manage'),
    exam: document.getElementById('nav-exam')
  };

  function showSection(name){
    Object.values(sections).forEach(s => s.classList.add('hidden'));
    sections[name].classList.remove('hidden');
    pageTitle.textContent = name === 'dashboard' ? 'Dashboard' : name === 'create' ? 'Buat Mata Kuliah' : name === 'manage' ? 'Kelola Soal' : 'Mode Ujian';
    
    // Nav active
    Object.values(nav).forEach(b => b.classList.remove('bg-white/5'));
    if(name === 'dashboard') nav.dashboard.classList.add('bg-white/5');
    if(name === 'create') nav.create.classList.add('bg-white/5');
    if(name === 'manage') nav.manage.classList.add('bg-white/5');
    if(name === 'exam') nav.exam.classList.add('bg-white/5');
  }

  nav.dashboard.addEventListener('click', ()=> showSection('dashboard'));
  nav.create.addEventListener('click', ()=> showSection('create'));
  nav.manage.addEventListener('click', ()=> showSection('manage'));
  nav.exam.addEventListener('click', ()=> showSection('exam'));
  document.getElementById('open-create').addEventListener('click', ()=> showSection('create'));

  // state
  let courses = [], currentCourse = null, questions = [], editing = null;
  let newCourseImage = null;

  // UI elements references
  const coursesGrid = document.getElementById('courses-grid');

  async function loadCourses(){
    const { data, error } = await sb.from('courses').select('*').order('created_at', { ascending: false });
    if(error){ console.error(error); alert('Gagal memuat mata kuliah: '+error.message); return; }
    courses = data || [];
    renderCourses(); 
    populateSelects();
  }

  function escapeHtml(s){ return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function renderCourses(){
    coursesGrid.innerHTML = '';
    const lim = 10;
    if(courses.length === 0){ 
      coursesGrid.innerHTML = '<div class="p-4 card col-span-full text-center">Belum ada mata kuliah. Buat mata kuliah baru.</div>'; 
      return; 
    }
    
    courses.forEach(c=>{
      const el = document.createElement('div'); 
      el.className = 'p-4 card flex flex-col justify-between h-48';
      el.innerHTML = `
        <div>
          <div class="text-xs muted">Mata Kuliah</div>
          <div class="font-semibold text-lg">${escapeHtml(c.name)}</div>
          <div class="text-sm muted mt-1 course-preview" id="preview-${c.id}">Memuat preview...</div>
        </div>
        <div class="flex justify-end items-center gap-2 mt-4">
          <button data-id="${c.id}" class="open-manage px-3 py-1 rounded bg-indigo-600 text-white text-sm">Kelola</button>
          <button data-id="${c.id}" class="delete-course px-3 py-1 rounded bg-rose-500 text-white text-sm">Hapus</button>
        </div>
      `;
      coursesGrid.appendChild(el);

      // Load preview questions
      (async ()=>{
        const { data: qd, error } = await sb.from('questions').select('id,teks').eq('course_id', c.id).order('created_at', { ascending: true }).limit(lim);
        const p = document.getElementById('preview-' + c.id);
        if(error) {
          p.innerHTML = '<div class="text-xs muted">Error memuat soal</div>';
          return;
        }
        
        if(qd && qd.length) {
          p.innerHTML = qd.map((q,i)=>`<div class="text-sm">${i+1}. ${escapeHtml(q.teks.slice(0,80))}${q.teks.length>80?'...':''}</div>`).join('');
        } else {
          p.innerHTML = '<div class="text-xs muted">Belum ada soal</div>';
        }
      })();
    });

    document.querySelectorAll('.open-manage').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.id; 
        const c = courses.find(x=>x.id===id);
        if(!c) return; 
        await openManageForCourse(c); 
        showSection('manage');
      });
    });
    document.querySelectorAll('.delete-course').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.id;
        const c = courses.find(x=>x.id===id);
        if(!c) return;
        if(confirm(`Apakah Anda yakin ingin menghapus mata kuliah "${c.name}"? Ini akan menghapus semua soal di dalamnya.`)){
          const { error } = await sb.from('courses').delete().eq('id', id);
          if(error) {
            alert('Gagal menghapus mata kuliah: ' + error.message);
          } else {
            alert('Mata kuliah berhasil dihapus.');
            await loadCourses();
            showSection('dashboard');
          }
        }
      });
    });
  }

  // Create Course: image pick
  const fileNew = document.getElementById('file-new'), pickNew = document.getElementById('pick-new'), clearNew = document.getElementById('clear-new'), previewNew = document.getElementById('preview-new');
  pickNew.addEventListener('click', ()=> fileNew.click());
  fileNew.addEventListener('change', e => handleFileInput(e,'new'));
  clearNew.addEventListener('click', ()=> { newCourseImage = null; previewNew.src=''; previewNew.classList.add('hidden'); fileNew.value=''; });
  document.getElementById('drop-new').addEventListener('drop', e=>{ e.preventDefault(); handleDrop(e,'new'); });
  document.getElementById('drop-new').addEventListener('dragover', e=> e.preventDefault());

  async function createCourse(){
    const name = document.getElementById('course-name').value.trim();
    if(!name) return alert('Nama mata kuliah wajib.');
    const { data, error } = await sb.from('courses').insert({ name }).select().single();
    if(error){ alert('Gagal membuat matkul: '+error.message); return; }
    const courseId = data.id;
    const teks = document.getElementById('initial-question').value.trim();
    const opts = Array.from(document.querySelectorAll('.opt.init')).map(i=>i.value.trim()).filter(Boolean);
    const key = document.getElementById('initial-key').value;
    let gambarUrl = null;
    if(newCourseImage) {
      gambarUrl = await uploadImage(newCourseImage);
    }
    if(teks && opts.length >= 2 && key !== '') {
      const { error: qErr } = await sb.from('questions').insert({ course_id: courseId, teks, opsi: opts, kunci: parseInt(key,10), gambar: gambarUrl });
      if(qErr) console.warn('Initial question error', qErr);
    }
    document.getElementById('course-name').value=''; 
    document.getElementById('initial-question').value='';
    document.querySelectorAll('.opt.init').forEach(i=>i.value=''); 
    document.getElementById('initial-key').value='';
    newCourseImage = null; 
    previewNew.src=''; 
    previewNew.classList.add('hidden'); 
    fileNew.value='';
    await loadCourses();
    alert('Mata kuliah berhasil dibuat.'); 
    showSection('dashboard');
  }
  document.getElementById('create-course').addEventListener('click', createCourse);
  
  function handleFileInput(e,target){
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      if(target === 'new'){ 
        newCourseImage = ev.target.result;
        previewNew.src = newCourseImage; 
        previewNew.classList.remove('hidden');
      }
      else if(target === 'q'){ 
        editing._localImage = ev.target.result;
        document.getElementById('preview-q').src = editing._localImage; 
        document.getElementById('preview-q').classList.remove('hidden');
      }
    };
    reader.readAsDataURL(f);
  }

  function handleDrop(e,target){
    const f = e.dataTransfer.files[0]; 
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      if(target === 'new'){ 
        newCourseImage = ev.target.result;
        previewNew.src=newCourseImage; 
        previewNew.classList.remove('hidden'); 
      }
      else if(target === 'q'){ 
        editing._localImage = ev.target.result;
        document.getElementById('preview-q').src = editing._localImage; 
        document.getElementById('preview-q').classList.remove('hidden');
      }
    }; 
    reader.readAsDataURL(f);
  }

  async function uploadImage(dataUrl){
    if(!dataUrl) return null;
    try{
      const res = await fetch(dataUrl); 
      const blob = await res.blob();
      const filename = `img_${Date.now()}.png`;
      const { data, error } = await sb.storage.from(STORAGE_BUCKET).upload(filename, blob, { cacheControl:'3600', upsert:false });
      if(error){ 
        console.warn('upload error', error.message); 
        return dataUrl;
      }
      const { data: urlData } = sb.storage.from(STORAGE_BUCKET).getPublicUrl(filename);
      return (urlData && urlData.publicUrl) ? urlData.publicUrl : dataUrl;
    }catch(err){ 
      console.warn('upload exception', err); 
      return dataUrl;
    }
  }

  // Manage section
  const selectManage = document.getElementById('select-manage');
  const btnAddQ = document.getElementById('btn-add-q');
  selectManage.addEventListener('change', async ()=> { 
    const courseId = selectManage.value;
    const course = courses.find(c => c.id === courseId);
    if (course) {
      await openManageForCourse(course); 
      btnAddQ.disabled = false; 
    } else {
      btnAddQ.disabled = true;
      document.getElementById('questions-list').innerHTML = '<div class="muted">Pilih mata kuliah terlebih dahulu.</div>';
    }
  });

  async function openManageForCourse(course){
    currentCourse = course;
    if(!course){ 
      document.getElementById('questions-list').innerHTML = '<div class="muted">Pilih mata kuliah terlebih dahulu.</div>';
      return;
    }
    
    const { data, error } = await sb.from('questions').select('*').eq('course_id', course.id).order('created_at', { ascending: false });
    if(error){ 
      alert('Gagal ambil soal: '+error.message); 
      return; 
    }
    questions = data || []; 
    renderQuestionList();
  }

  function renderQuestionList(){
    const wrap = document.getElementById('questions-list'); 
    wrap.innerHTML = '';
    if(!questions || questions.length === 0){ 
      wrap.innerHTML = '<div class="no-questions">Belum ada soal untuk mata kuliah ini.</div>';
      return;
    }
    
    questions.forEach(q=>{
      const div = document.createElement('div'); 
      div.className = 'question-item';
      div.innerHTML = `
        <div class="question-text">${escapeHtml(q.teks)}</div>
        <div class="text-xs muted">${new Date(q.created_at).toLocaleString('id-ID')}</div>
        <div class="question-options">
          ${(q.opsi||[]).map((o,idx)=>`
            <div class="question-option ${idx===q.kunci ? 'correct-option' : ''}">
              <span class="font-semibold">${String.fromCharCode(65+idx)}.</span> ${escapeHtml(o)}
            </div>
          `).join('')}
        </div>
        ${q.gambar ? `<img src="${q.gambar}" class="question-image" />` : ''}
        <div class="question-actions">
          <button data-id="${q.id}" class="edit-q px-3 py-1 bg-white/10 rounded text-sm">Edit</button>
          <button data-id="${q.id}" class="del-q px-3 py-1 bg-rose-500 text-white rounded text-sm">Hapus</button>
        </div>
      `;
      wrap.appendChild(div);
    });
    // bind actions
    wrap.querySelectorAll('.del-q').forEach(b=> b.addEventListener('click', async ()=>{
      if(!confirm('Hapus soal?')) return;
      const id = b.dataset.id; 
      const { error } = await sb.from('questions').delete().eq('id', id);
      if(error) return alert('Gagal hapus: '+error.message);
      await openManageForCourse(currentCourse);
    }));
    wrap.querySelectorAll('.edit-q').forEach(b=> b.addEventListener('click', ()=>{
      const id = b.dataset.id; 
      const q = questions.find(x=>x.id===id); 
      if(!q) return;
      editing = JSON.parse(JSON.stringify(q));
      editorTitle.textContent = 'Edit Soal';
      document.getElementById('qe-text').value = editing.teks || '';
      for(let i=0;i<4;i++) document.getElementById('qe-opt-'+i).value = (editing.opsi && editing.opsi[i]) || '';
      document.getElementById('qe-key').value = editing.kunci !== null && editing.kunci !== undefined ? editing.kunci : '';
      
      if(editing.gambar){ 
        document.getElementById('preview-q').src = editing.gambar; 
        document.getElementById('preview-q').classList.remove('hidden'); 
      } else { 
        document.getElementById('preview-q').classList.add('hidden'); 
      }
      showPopout();
    }));
  }
  
  // Pop-out functions
  function showPopout(){
    editorPopout.classList.remove('hidden');
    setTimeout(()=> editorPopoutContent.classList.add('show'), 10);
  }

  function hidePopout(){
    editorPopoutContent.classList.remove('show');
    setTimeout(()=> editorPopout.classList.add('hidden'), 200);
  }

  // Add question button
  btnAddQ.addEventListener('click', ()=> {
    if(!currentCourse) return alert('Pilih mata kuliah dulu');
    editing = { id:null, teks:'', opsi:['','','',''], kunci:'', gambar:null, _localImage:null };
    editorTitle.textContent = 'Tambah Soal';
    document.getElementById('qe-text').value = '';
    for(let i=0;i<4;i++) document.getElementById('qe-opt-'+i).value='';
    document.getElementById('qe-key').value='';
    document.getElementById('preview-q').classList.add('hidden');
    document.getElementById('preview-q').src='';
    document.getElementById('file-q').value = '';
    document.getElementById('upload-status').textContent = '';
    showPopout();
  });

  // editor file handlers
  const fileQ = document.getElementById('file-q'), pickQ = document.getElementById('pick-q'), clearQ = document.getElementById('clear-q'), previewQ = document.getElementById('preview-q');
  pickQ.addEventListener('click', ()=> fileQ.click());
  fileQ.addEventListener('change', (e)=> handleFileInput(e,'q'));
  clearQ.addEventListener('click', ()=> {
    editing._localImage = null;
    editing.gambar = null;
    previewQ.src='';
    previewQ.classList.add('hidden');
    fileQ.value='';
  });
  document.getElementById('drop-q').addEventListener('drop', e=>{ e.preventDefault(); handleDrop(e,'q'); });
  document.getElementById('drop-q').addEventListener('dragover', e=> e.preventDefault());

  // Save question
  saveQBtn.addEventListener('click', async ()=>{
    const teks = document.getElementById('qe-text').value.trim();
    const opsi = [0,1,2,3].map(i=>document.getElementById('qe-opt-'+i).value.trim()).filter(Boolean);
    const key = document.getElementById('qe-key').value;
    
    if(!teks) return alert('Teks soal wajib diisi.');
    if(opsi.length < 2) return alert('Minimal diperlukan 2 opsi jawaban.');
    if(key === '') return alert('Kunci jawaban wajib dipilih.');

    let gambarToSave = editing._localImage || editing.gambar || null;
    if(editing._localImage) {
      gambarToSave = await uploadImage(editing._localImage);
    }

    if(editing.id){
      const { error } = await sb.from('questions').update({ 
        teks, 
        opsi, 
        kunci: parseInt(key,10), 
        gambar: gambarToSave 
      }).eq('id', editing.id);
      
      if(error) return alert('Gagal update: '+error.message);
      alert('Soal diperbarui');
    } else {
      const { data, error } = await sb.from('questions').insert({ 
        course_id: currentCourse.id, 
        teks, 
        opsi, 
        kunci: parseInt(key,10), 
        gambar: gambarToSave 
      }).select().single();
      if(error) return alert('Gagal tambah: '+error.message);
      alert('Soal ditambahkan');
    }
    
    await openManageForCourse(currentCourse);
    hidePopout();
  });
  editorCancelBtn.addEventListener('click', hidePopout);

  // File Upload feature inside pop-out
  const fileUploadEl = document.getElementById('file-upload');
  const uploadStatusEl = document.getElementById('upload-status');
  fileUploadEl.addEventListener('change', async (e) => {
    if(!currentCourse) {
      alert('Pilih mata kuliah terlebih dahulu untuk mengunggah soal.');
      fileUploadEl.value = '';
      return;
    }
    const file = e.target.files[0];
    if(!file) return;

    uploadStatusEl.textContent = 'Mengunggah dan memproses file...';
    try {
      const text = await file.text();
      const questionsToInsert = parseQuestionsFromFile(text);

      if (questionsToInsert.length > 0) {
        const { error } = await sb.from('questions').insert(questionsToInsert);
        if (error) {
          uploadStatusEl.textContent = `Gagal mengunggah soal: ${error.message}`;
          alert(`Gagal mengunggah soal: ${error.message}`);
        } else {
          uploadStatusEl.textContent = `Berhasil mengunggah ${questionsToInsert.length} soal.`;
          await openManageForCourse(currentCourse);
          alert(`Berhasil mengunggah ${questionsToInsert.length} soal.`);
        }
      } else {
        uploadStatusEl.textContent = 'Tidak ada soal yang valid ditemukan di file.';
      }
    } catch (err) {
      uploadStatusEl.textContent = `Error: ${err.message}`;
      alert(`Terjadi kesalahan saat memproses file: ${err.message}`);
    } finally {
      fileUploadEl.value = '';
    }
  });

  function parseQuestionsFromFile(text) {
    const lines = text.split('\n').map(line => line.trim()).filter(Boolean);
    const questions = [];
    let currentQ = null;
    lines.forEach(line => {
      if (line.startsWith('Q:')) {
        if (currentQ) {
          // Simpan soal sebelumnya jika valid
          if (currentQ.teks && currentQ.opsi.length >= 2 && currentQ.kunci !== null) {
            questions.push(currentQ);
          }
        }
        currentQ = { 
          course_id: currentCourse.id, 
          teks: line.substring(2).trim(), 
          opsi: [], 
          kunci: null 
        };
      } else if (line.startsWith('A:')) {
        if (currentQ) currentQ.opsi[0] = line.substring(2).trim();
      } else if (line.startsWith('B:')) {
        if (currentQ) currentQ.opsi[1] = line.substring(2).trim();
      } else if (line.startsWith('C:')) {
        if (currentQ) currentQ.opsi[2] = line.substring(2).trim();
      } else if (line.startsWith('D:')) {
        if (currentQ) currentQ.opsi[3] = line.substring(2).trim();
      } else if (line.startsWith('K:')) {
        const keyChar = line.substring(2).trim().toUpperCase();
        if (currentQ) {
          const keyMap = {'A': 0, 'B': 1, 'C': 2, 'D': 3};
          currentQ.kunci = keyMap[keyChar] !== undefined ? keyMap[keyChar] : null;
        }
      }
    });
    // Tambahkan soal terakhir
    if (currentQ && currentQ.teks && currentQ.opsi.length >= 2 && currentQ.kunci !== null) {
      questions.push(currentQ);
    }

    return questions;
  }

  // EXAM: show all and scroll-spy + mobile numbers
  const selectExam = document.getElementById('select-exam');
  const sidebarEl = document.getElementById('exam-sidebar');
  const gridEl = document.getElementById('exam-grid');
  const mobileNumbersWrap = document.querySelector('#mobile-numbers > div');
  const progressBar = document.getElementById('exam-progress');
  const progressText = document.getElementById('progress-text');
  const startExamBtn = document.getElementById('start-exam');
  const endExamBtn = document.getElementById('end-exam');
  const examScoreDisplay = document.getElementById('exam-score-display');
  let examState = { active: false, finished: false, items: [], answers: {}, refs: {}, answeredCount: 0 };

  async function startExam(){
    const courseId = selectExam.value;
    const course = courses.find(x => x.id === courseId);
    if(!course) {
      alert('Belum ada mata kuliah untuk memulai ujian.');
      return;
    }
    
    const { data, error } = await sb.from('questions').select('*').eq('course_id', course.id);
    if(error) {
      alert('Gagal memuat soal: ' + error.message);
      return;
    }
    
    if(!data || data.length === 0) {
      alert('Belum ada soal di mata kuliah ini.');
      return;
    }

    // Shuffle and limit to 50
    const arr = data.sort(() => Math.random() - 0.5).slice(0, Math.min(50, data.length));
    examState.active = true;
    examState.finished = false;
    examState.items = arr;
    examState.answers = {};
    examState.refs = {};
    examState.answeredCount = 0;
    // UI states
    startExamBtn.classList.add('hidden');
    endExamBtn.classList.remove('hidden');
    selectExam.disabled = true;
    examScoreDisplay.classList.add('hidden');
    renderExamAll();
    setTimeout(()=> { document.getElementById('exam-grid').scrollTo({ top:0, behavior:'smooth' }); }, 80);
  }

  async function endExam(){
    examState.finished = true;
    let correctAnswers = 0;
    // Iterate and check answers
    examState.items.forEach(q => {
      const userAnswer = examState.answers[q.id];
      if (userAnswer === q.kunci) {
        correctAnswers++;
      }
      updateQuestionVisual(q.id, true); // Show correct answer and user's answer
    });
    const totalQuestions = examState.items.length;
    const score = Math.round((correctAnswers / totalQuestions) * 100);
    examScoreDisplay.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold text-lg">Ujian Selesai!</div>
          <div class="small-muted">Jawaban benar: ${correctAnswers} dari ${totalQuestions}</div>
        </div>
        <div class="text-3xl font-bold">${score}</div>
      </div>
    `;
    examScoreDisplay.classList.remove('hidden');
    endExamBtn.classList.add('hidden');
    startExamBtn.classList.remove('hidden');
    document.getElementById('select-exam').disabled = false;
    document.getElementById('select-exam').value = '';
    // Reload courses to update counts if needed
    await loadCourses();
  }

  function renderExamAll(){
    gridEl.innerHTML = '';
    sidebarEl.innerHTML = '';
    mobileNumbersWrap.innerHTML = '';
    examState.items.forEach((q, i) => {
      // Create sidebar/mobile button
      const btn = document.createElement('button');
      btn.textContent = i + 1;
      btn.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold transition-colors duration-200 bg-white/5';
      btn.dataset.id = q.id;
      btn.dataset.index = i;
      btn.addEventListener('click', () => scrollToQuestion(q.id));
      sidebarEl.appendChild(btn.cloneNode(true));
      
      const mobileBtn = btn.cloneNode(true);
      mobileBtn.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold transition-colors duration-200 bg-white/5';
      mobileNumbersWrap.appendChild(mobileBtn);

      // Create question card
      const card = document.createElement('div');
      card.id = `q-${q.id}`;
      card.className = 'p-4 card flex flex-col gap-3';
      card.innerHTML = `
        <div class="font-medium flex items-start gap-2">
          <div class="flex-shrink-0 text-white/40">${i+1}.</div>
          <div>${escapeHtml(q.teks)}</div>
        </div>
        ${q.gambar ? `<img src="${q.gambar}" class="rounded max-h-40" />` : ''}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          ${q.opsi.map((o, idx) => `
            <button class="exam-opt w-full text-left p-3 border rounded border-white/10 hover:bg-white/5 transition-colors duration-200" data-qid="${q.id}" data-idx="${idx}">
              <span class="text-white/40">${String.fromCharCode(65+idx)}.</span> ${escapeHtml(o)}
            </button>
          `).join('')}
        </div>
      `;
      gridEl.appendChild(card);
      examState.refs[q.id] = { element: card, sidebarBtn: btn, mobileBtn: mobileBtn };
    });
    // Option click listener
    gridEl.querySelectorAll('.exam-opt').forEach(b => {
      b.addEventListener('click', () => {
        if (examState.finished) return; // Prevent clicking after exam ends
        const qid = b.dataset.qid;
        const idx = parseInt(b.dataset.idx, 10);
        const card = document.getElementById(`q-${qid}`);
        
        // Remove active state from other options
        card.querySelectorAll('.exam-opt').forEach(opt => opt.classList.remove('bg-indigo-600', 'text-white'));
        
        // Add active state to clicked option
        b.classList.add('bg-indigo-600', 'text-white');
        
        const isNewAnswer = examState.answers[qid] === undefined;
        examState.answers[qid] = idx;
        if(isNewAnswer) {
          examState.answeredCount++;
        }
        updateProgress();
        updateQuestionVisual(qid);
      });
    });
    updateProgress();
  }

  function scrollToQuestion(qid){
    const qEl = document.getElementById(`q-${qid}`);
    if(qEl) qEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function updateQuestionVisual(qid, isFinished = false){
    const ref = examState.refs[qid];
    if(!ref) return;
    // Sidebar button color
    const btn = ref.sidebarBtn;
    const mobileBtn = ref.mobileBtn;
    if(examState.answers[qid] !== undefined) {
        btn.classList.add('bg-indigo-600', 'text-white');
        btn.classList.remove('bg-white/5');
        mobileBtn.classList.add('bg-indigo-600', 'text-white');
        mobileBtn.classList.remove('bg-white/5');
    } else {
        btn.classList.remove('bg-indigo-600', 'text-white');
        btn.classList.add('bg-white/5');
        mobileBtn.classList.remove('bg-indigo-600', 'text-white');
        mobileBtn.classList.add('bg-white/5');
    }

    if(isFinished){
        const q = examState.items.find(x=>x.id===qid);
        const userAnswer = examState.answers[qid];
        const card = document.getElementById(`q-${qid}`);
        card.querySelectorAll('.exam-opt').forEach(opt => {
            const idx = parseInt(opt.dataset.idx, 10);
            opt.classList.remove('bg-indigo-600');
            opt.style.pointerEvents = 'none';

            if(idx === q.kunci){
                opt.classList.add('bg-emerald-600');
            } else if(idx === userAnswer && idx !== q.kunci){
                opt.classList.add('bg-rose-600');
            }
        });
        // Sidebar color for finished state
        if (userAnswer === q.kunci) {
            btn.style.background = '#10B981';
            btn.style.color = '#fff';
            mobileBtn.style.background = '#10B981';
            mobileBtn.style.color = '#fff';
        } else {
            btn.style.background = '#EF4444';
            btn.style.color = '#fff';
            mobileBtn.style.background = '#EF4444';
            mobileBtn.style.color = '#fff';
        }
    }
  }

  function updateProgress(){
    const total = examState.items.length;
    const answered = examState.answeredCount || Object.keys(examState.answers).length;
    const pct = total ? Math.round((answered/total)*100) : 0;
    progressBar.style.width = pct + '%';
    progressText.textContent = `${answered} / ${total} dijawab`;
  }

  function populateSelects(){
    const selManage = document.getElementById('select-manage');
    const selExam = document.getElementById('select-exam');
    
    // Simpan nilai terpilih saat ini
    const curManageId = selectManage.value;
    const curExamId = selExam.value;

    // Bersihkan opsi yang ada
    selManage.innerHTML = '<option value="">— Pilih Mata Kuliah —</option>';
    selExam.innerHTML = '<option value="">— Pilih Mata Kuliah —</option>';

    // Isi ulang opsi dengan data terbaru
    courses.forEach(c => { 
        const o1 = document.createElement('option');
        o1.value = c.id;
        o1.textContent = c.name;
        selManage.appendChild(o1);

        const o2 = document.createElement('option');
        o2.value = c.id;
        o2.textContent = c.name;
        selExam.appendChild(o2);
    });

    // Kembalikan nilai terpilih sebelumnya
    if(curManageId && courses.find(c => c.id === curManageId)) {
        selManage.value = curManageId;
    }
    if(curExamId && courses.find(c => c.id === curExamId)) {
        selExam.value = curExamId;
    }
    
    // Perbarui status tombol "Tambah Soal" dan "Mulai Ujian"
    btnAddQ.disabled = !selectManage.value;
    startExamBtn.disabled = !selExam.value;
  }

  // Event listeners untuk tombol batal
  document.getElementById('cancel-create').addEventListener('click', () => {
    showSection('dashboard');
  });
  
  // Event listeners untuk tombol mulai ujian dan selesai ujian
  startExamBtn.addEventListener('click', startExam);
  endExamBtn.addEventListener('click', endExam);
  
  // Perbarui status tombol "Mulai Ujian" saat dropdown berubah
  selectExam.addEventListener('change', () => {
    startExamBtn.disabled = !selectExam.value;
  });

  // Initial load
  loadCourses();
})();
</script>
</body>
</html>
