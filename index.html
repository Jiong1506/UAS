<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ujian Akhir Semester</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --bg: #111827;
      --card: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #6366f1;
      --success-clr: #10b981;
      --danger-clr: #ef4444;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      transition: background-color .25s, color .25s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      transition: background-color .25s, box-shadow .25s;
    }
    
    .course-card {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .course-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    .btn {
      background: linear-gradient(90deg, #6366f1, #a855f7);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform .1s, opacity .1s;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); opacity: 0.9; }

    .btn-danger {
      background: var(--danger-clr);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform .1s, opacity .1s;
    }
    .btn-danger:hover { transform: translateY(-1px); }
    .btn-danger:active { transform: translateY(0); opacity: 0.9; }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--muted);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: color .25s, border-color .25s;
    }
    .btn-ghost:hover { color: var(--text); border-color: var(--text); }

    .muted { color: var(--muted); }
    .small-muted { color: var(--muted); font-size: .9rem; }

    .sidebar-scroll { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.12) transparent; }
    .sidebar-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 999px; }

    [data-cloak] { display: none; }

    /* --- Responsiveness: Tampilan Berbeda untuk Setiap Mode --- */

    /* Default (Mobile Portrait) */
    .layout { flex-direction: column; }
    .main-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
    aside.sidebar { width: 100%; flex-direction: column; gap: 6px; padding: 8px; overflow-x: hidden; overflow-y: hidden; }
    aside.sidebar .logo-area, aside.sidebar .theme-toggle-area { display: none; }
    aside.sidebar nav { flex-direction: column; }
    aside.sidebar button { flex: 0 0 auto; }
    .mobile-floating { display: block; } /* Diubah ke block untuk menampung card di bawah */
    #mobile-numbers > div {
        display: grid;
        grid-template-columns: repeat(5, 1fr); /* 5 kolom */
        gap: 8px;
        justify-content: center;
    }
    .exam-grid { grid-template-columns: 1fr; }

    /* Media Query: Mobile Landscape (lebar minimal 576px) */
    @media (min-width: 576px) and (max-width: 899px) {
      .layout { flex-direction: row; }
      .main-header { flex-direction: row; align-items: center; gap: 0; }
      aside.sidebar { width: 12rem; min-width: 12rem; max-width: 12rem; flex-direction: column; padding: 1rem; }
      aside.sidebar .logo-area { display: flex; }
      aside.sidebar nav { flex-direction: column; }
      .mobile-floating { display: none; }
      .exam-grid { grid-template-columns: 1fr 1fr; }
    }

    /* Media Query: Tablet dan PC (lebar minimal 900px) */
    @media (min-width: 900px) {
      .layout { flex-direction: row; }
      .main-header { flex-direction: row; align-items: center; gap: 0; }
      aside.sidebar { width: 18rem; min-width: 18rem; flex-direction: column; padding: 1.5rem; }
      aside.sidebar .logo-area { display: flex; }
      aside.sidebar nav { flex-direction: column; }
      .mobile-floating { display: none; }
      .exam-grid { grid-template-columns: 1fr 1fr 1fr; }
    }

    /* Penyesuaian untuk dropdown dan input agar gelap */
    select.dark-select {
        background-color: var(--card) !important;
        color: var(--text) !important;
        border-color: var(--muted) !important;
    }

    select.dark-select option {
        background-color: var(--card) !important;
        color: var(--text) !important;
    }

    input.dark-input, textarea.dark-input {
      background-color: var(--card) !important;
      color: var(--text) !important;
      border-color: var(--muted) !important;
    }

    /* Penyesuaian untuk dropzone gambar */
    .image-dropzone {
      background-color: var(--card);
      color: var(--text);
      border: 1px dashed var(--muted);
      border-radius: 12px;
    }
  </style>
</head>
<body data-theme="dark">

<script>
  const SUPABASE_URL = 'https://znosqyapmdfujtqwdsdm.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpub3NxeWFwbWRmdWp0cXdkc2RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDE1MTIsImV4cCI6MjA3MzIxNzUxMn0.R-WmeGOY0LX0oJv-UhWloXfAFVyGrbTgBYF3X1cHeUk';
  const STORAGE_BUCKET = 'question-images';
</script>

<div id="app" class="min-h-screen layout flex" data-cloak>

  <aside class="sidebar card flex-shrink-0 flex flex-col gap-4">
    <div class="logo-area flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-gradient-to-br from-purple-600 to-indigo-600">
        <svg fill="white" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.31.31l5.112 2.125a.563.563 0 010 1.04l-5.111 2.125a.563.563 0 00-.31.31l-2.125 5.112a.563.563 0 01-1.04 0l-2.125-5.111a.563.563 0 00-.31-.31l-5.112-2.125a.563.563 0 010-1.04l5.111-2.125a.563.563 0 00.31-.31L11.48 3.5z" />
        </svg>
      </div>
      <div>
        <div class="font-semibold">Ujian Akhir Semester</div>
      </div>
    </div>

    <nav class="flex gap-2">
      <button id="nav-dashboard" class="text-left px-3 py-2 rounded-md bg-white/5">Dashboard</button>
      <button id="nav-create" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Buat Mata Kuliah</button>
      <button id="nav-manage" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Kelola Soal</button>
      <button id="nav-exam" class="text-left px-3 py-2 rounded-md hover:bg-white/5">Jalankan Ujian</button>
    </nav>
  </aside>

  <main class="flex-1 p-6 overflow-y-auto">
    <div class="main-header flex items-center justify-between mb-6">
      <div>
        <h1 id="page-title" class="text-3xl font-bold">Dashboard</h1>
        <p id="page-sub" class="text-sm muted">Ringkasan mata kuliah & soal</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="open-create" class="btn">Buat Mata Kuliah</button>
      </div>
    </div>

    <section id="dashboard-section">
      <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <section id="create-section" class="hidden">
      <div class="card p-4 shadow-lg rounded-xl">
        <h2 class="text-xl font-semibold">Buat Mata Kuliah</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm muted">Nama Mata Kuliah</label>
            <input id="course-name" class="mt-2 p-3 border rounded w-full bg-transparent dark-input" placeholder="Contoh: Basis Data" />
            <label class="text-sm muted mt-3 block">Soal pertama (opsional)</label>
            <textarea id="initial-question" class="mt-2 p-3 border rounded w-full bg-transparent dark-input" placeholder="Teks soal (opsional)"></textarea>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi A" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi B" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi C" />
              <input class="opt init p-2 border rounded dark-input" placeholder="Opsi D" />
            </div>
            <div class="flex items-center gap-2 mt-3">
              <select id="initial-key" class="p-2 border rounded bg-transparent muted dark-select">
                <option value="">Kunci (opsional)</option>
                <option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-sm muted">Gambar (opsional)</label>
            <div id="drop-new" class="mt-2 p-3 border rounded flex flex-col items-center justify-center image-dropzone h-40">
              <div class="text-sm muted">Tarik & lepas atau pilih file</div>
              <input id="file-new" type="file" accept="image/*" class="hidden" />
              <div class="mt-3 flex gap-2">
                <button id="pick-new" class="btn py-2 px-4 text-sm">Pilih Gambar</button>
                <button id="clear-new" class="btn-ghost py-2 px-4 text-sm">Hapus</button>
              </div>
              <img id="preview-new" class="mt-3 max-h-28 rounded hidden" alt="preview" />
            </div>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="create-course" class="btn py-2 px-4">Buat</button>
          <button id="cancel-create" class="btn-ghost py-2 px-4">Batal</button>
        </div>
      </div>
    </section>

    <section id="manage-section" class="hidden">
      <div class="card p-4 shadow-lg rounded-xl">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between flex-wrap gap-2 mb-4">
          <div>
            <h2 class="text-xl font-semibold">Kelola Soal</h2>
            <p class="text-sm muted">Pilih mata kuliah lalu tambah/edit/hapus soal.</p>
          </div>
          <div class="flex flex-col sm:flex-row items-stretch gap-2 w-full sm:w-auto">
            <select id="select-manage" class="p-2 border rounded bg-transparent dark-select flex-1">
              <option value="">— Pilih Mata Kuliah —</option>
            </select>
            <button id="btn-add-q" class="btn text-sm px-3 py-2 sm:self-auto" disabled>Tambah Soal</button>
          </div>
        </div>
        
        <div class="card p-4 mt-4 flex flex-col items-start gap-2 shadow-md rounded-xl">
            <h3 class="text-md font-semibold">Unggah Soal dari File Teks</h3>
            <p class="text-sm muted">Pilih mata kuliah lalu unggah file .txt.
            Lihat <a href="#" class="underline" onclick="alert('Format file:\n\nQ: Teks soal\nA: Opsi A\nB: Opsi B\nK: A\n\nSetiap soal dipisahkan oleh baris baru. Gambar tidak didukung.')">format file</a>.</p>
            <div class="flex items-center gap-2 w-full">
              <input type="file" id="file-upload" accept=".txt" class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 bg-transparent text-white/90" />
            </div>
            <p id="upload-status" class="text-sm muted mt-2"></p>
        </div>
        
        <div id="questions-list" class="mt-4 space-y-3"></div>
      </div>
    </section>

    <section id="editor-section" class="hidden mt-4">
      <div class="card p-4 shadow-lg rounded-xl">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <h3 id="editor-title" class="text-xl font-semibold">Tambah Soal</h3>
          <div>
            <button id="editor-cancel" class="btn-ghost py-2 px-4">Batal</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm muted">Teks Soal</label>
            <textarea id="qe-text" class="mt-2 p-3 border rounded w-full bg-transparent dark-input"></textarea>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input id="qe-opt-0" class="p-2 border rounded dark-input" placeholder="Opsi A" />
              <input id="qe-opt-1" class="p-2 border rounded dark-input" placeholder="Opsi B" />
              <input id="qe-opt-2" class="p-2 border rounded dark-input" placeholder="Opsi C (opsional)" />
              <input id="qe-opt-3" class="p-2 border rounded dark-input" placeholder="Opsi D (opsional)" />
            </div>
            <div class="flex items-center gap-2 mt-3">
              <select id="qe-key" class="p-2 border rounded bg-transparent dark-select">
                <option value="">— Pilih Kunci —</option><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-sm muted">Gambar (opsional)</label>
            <div id="drop-q" class="mt-2 p-3 border rounded flex flex-col items-center justify-center image-dropzone h-44">
              <div class="text-sm muted">Tarik & lepas atau pilih file</div>
              <input id="file-q" type="file" accept="image/*" class="hidden" />
              <div class="mt-3 flex gap-2">
                <button id="pick-q" class="btn py-2 px-4 text-sm">Pilih</button>
                <button id="clear-q" class="btn-ghost py-2 px-4 text-sm">Hapus</button>
              </div>
              <img id="preview-q" class="mt-3 max-h-28 rounded hidden" alt="preview" />
            </div>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="save-q" class="btn py-2 px-4">Simpan Soal</button>
        </div>
      </div>
    </section>

    <section id="exam-section" class="hidden mt-4">
      <div class="card p-4 shadow-lg rounded-xl">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between flex-wrap gap-2 mb-4">
          <div>
            <h2 class="text-xl font-semibold">Mode Ujian — Tampilkan Semua Soal</h2>
            <p class="text-sm muted">Semua soal akan ditampilkan sekaligus (maks 50).
            Klik nomor di sidebar untuk lompat cepat.</p>
          </div>
          <div class="flex flex-col sm:flex-row items-stretch gap-2 w-full sm:w-auto">
            <select id="select-exam" class="p-2 border rounded bg-transparent dark-select flex-1">
              <option value="">— Pilih Mata Kuliah —</option>
            </select>
            <button id="start-exam" class="btn text-sm px-3 py-2 sm:self-auto">Mulai Ujian</button>
            <button id="end-exam" class="btn-danger text-sm px-3 py-2 sm:self-auto hidden">Selesai Ujian</button>
          </div>
        </div>
        <div id="exam-score-display" class="card p-4 my-4 hidden"></div>

        <div class="mt-4 flex gap-4">
          <aside id="exam-sidebar" class="hidden md:block w-16 sidebar-scroll h-[70vh] overflow-y-auto p-2 card">
            </aside>

          <div class="flex-1">
            <div class="flex items-center justify-between mb-3">
              <div class="small-muted">Progress</div>
              <div class="small-muted" id="progress-text">0 / 0 dijawab</div>
            </div>
            <div class="h-2 bg-white/5 rounded overflow-hidden mb-4">
              <div id="exam-progress" class="h-2 rounded" style="width:0%; background: linear-gradient(90deg,var(--accent), #5b21b6)"></div>
            </div>
            <div id="exam-grid" class="grid gap-4 max-h-[70vh] overflow-y-auto p-1 exam-grid">
              </div>
          </div>
        </div>

        <div id="mobile-numbers" class="mobile-floating fixed bottom-4 left-1/2 -translate-x-1/2 z-50">
          <div class="card p-4 flex flex-col gap-2 shadow-lg w-[95vw] sm:w-[50vw]">
            <h3 class="font-semibold text-lg">Lompati Soal</h3>
            <div class="grid grid-cols-5 gap-2">
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>
</div>

<script>
  const SUPABASE_URL = 'https://znosqyapmdfujtqwdsdm.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpub3NxeWFwbWRmdWp0cXdkc2RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDE1MTIsImV4cCI6MjA3MzIxNzUxMn0.R-WmeGOY0LX0oJv-UhWloXfAFVyGrbTgBYF3X1cHeUk';
  const STORAGE_BUCKET = 'question-images';

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: false } });

  // DOM refs
  const app = document.getElementById('app'); app.removeAttribute('data-cloak');
  const pageTitle = document.getElementById('page-title');
  const pageSub = document.getElementById('page-sub');

  // Section refs
  const sections = {
    dashboard: document.getElementById('dashboard-section'),
    create: document.getElementById('create-section'),
    manage: document.getElementById('manage-section'),
    editor: document.getElementById('editor-section'),
    exam: document.getElementById('exam-section')
  };
  
  // Navigation buttons
  const nav = {
    dashboard: document.getElementById('nav-dashboard'),
    create: document.getElementById('nav-create'),
    manage: document.getElementById('nav-manage'),
    exam: document.getElementById('nav-exam')
  };
  function showSection(name){
    Object.values(sections).forEach(s => s.classList.add('hidden'));
    sections[name].classList.remove('hidden');
    pageTitle.textContent = name === 'dashboard' ? 'Dashboard' : name === 'create' ? 'Buat Mata Kuliah' : name === 'manage' ? 'Kelola Soal' : 'Mode Ujian';
    // Nav active
    Object.values(nav).forEach(b => b.classList.remove('bg-white/5'));
    if(name === 'dashboard') nav.dashboard.classList.add('bg-white/5');
    if(name === 'create') nav.create.classList.add('bg-white/5');
    if(name === 'manage') nav.manage.classList.add('bg-white/5');
    if(name === 'exam') nav.exam.classList.add('bg-white/5');
  }

  nav.dashboard.addEventListener('click', ()=> showSection('dashboard'));
  nav.create.addEventListener('click', ()=> showSection('create'));
  nav.manage.addEventListener('click', ()=> showSection('manage'));
  nav.exam.addEventListener('click', async ()=> { 
    showSection('exam'); 
    await startExam();
  });
  document.getElementById('open-create').addEventListener('click', ()=> showSection('create'));

  // state
  let courses = [], currentCourse = null, questions = [], editing = null;
  let newCourseImage = null;

  // UI elements references
  const coursesGrid = document.getElementById('courses-grid');

  async function loadCourses(){
    const { data, error } = await sb.from('courses').select('*').order('created_at', { ascending: false });
    if(error){ console.error(error); alert('Gagal memuat mata kuliah: '+error.message); return; }
    courses = data || [];
    renderCourses(); 
    populateSelects();
  }

  function escapeHtml(s){ return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function renderCourses(){
    coursesGrid.innerHTML = '';
    const lim = 10;
    if(courses.length === 0){ 
      coursesGrid.innerHTML = '<div class="p-4 card col-span-full text-center">Belum ada mata kuliah. Buat mata kuliah baru.</div>'; 
      return; 
    }
    
    courses.forEach(c=>{
      const el = document.createElement('div'); 
      el.className = 'p-4 card flex flex-col justify-between h-48 shadow-lg rounded-xl course-card';
      el.dataset.id = c.id;
      el.innerHTML = `
        <div>
          <div class="text-xs muted">Mata Kuliah</div>
          <div class="font-semibold text-lg">${escapeHtml(c.name)}</div>
          <div class="text-sm muted mt-1" id="preview-${c.id}">Memuat preview...</div>
        </div>
        <div class="flex justify-end items-center gap-2 mt-4">
          <button data-id="${c.id}" class="open-manage-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm">Kelola</button>
          <button data-id="${c.id}" class="delete-course px-3 py-1 rounded bg-rose-500 text-white text-sm">Hapus</button>
        </div>
      `;
      coursesGrid.appendChild(el);

      (async ()=>{
        const { data: qd } = await sb.from('questions').select('id,teks').eq('course_id', c.id).order('created_at', { ascending: true }).limit(lim);
        const p = document.getElementById('preview-' + c.id);
        if(qd && qd.length) {
          p.innerHTML = qd.map((q,i)=>`<div class="text-sm">${i+1}. ${escapeHtml(q.teks.slice(0,80))}${q.teks.length>80?'...':''}</div>`).join('');
        } else {
          p.innerHTML = '<div class="text-xs muted">Belum ada soal</div>';
        }
      })();
    });

    document.querySelectorAll('.course-card').forEach(card=>{
      card.addEventListener('click', async (e)=>{
        // Hanya jalankan jika target klik BUKAN tombol
        if (!e.target.closest('button')) {
          e.preventDefault(); // Mencegah perilaku default
          const id = card.dataset.id;
          const c = courses.find(x => x.id === id);
          if (!c) return;
          selectManage.value = c.name;
          await openManageForCourse(c.name);
          showSection('manage');
          btnAddQ.disabled = false;
        }
      });
    });

    document.querySelectorAll('.open-manage-btn').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const id = b.dataset.id; 
        const c = courses.find(x=>x.id===id);
        if(!c) return; 
        selectManage.value = c.name;
        await openManageForCourse(c.name); 
        showSection('manage');
        btnAddQ.disabled = false;
      });
    });
    
    document.querySelectorAll('.delete-course').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const id = b.dataset.id;
        const c = courses.find(x=>x.id===id);
        if(!c) return;
        if(confirm(`Apakah Anda yakin ingin menghapus mata kuliah "${c.name}"? Ini akan menghapus semua soal di dalamnya.`)){
          const { error } = await sb.from('courses').delete().eq('id', id);
          if(error) {
            alert('Gagal menghapus mata kuliah: ' + error.message);
          } else {
            alert('Mata kuliah berhasil dihapus.');
            await loadCourses();
            showSection('dashboard');
          }
        }
      });
    });
  }

  // Create Course: image pick
  const fileNew = document.getElementById('file-new'), pickNew = document.getElementById('pick-new'), clearNew = document.getElementById('clear-new'), previewNew = document.getElementById('preview-new');
  pickNew.addEventListener('click', ()=> fileNew.click());
  fileNew.addEventListener('change', e => handleFileInput(e,'new'));
  clearNew.addEventListener('click', ()=> { newCourseImage = null; previewNew.src=''; previewNew.classList.add('hidden'); fileNew.value=''; });
  document.getElementById('drop-new').addEventListener('drop', e=>{ e.preventDefault(); handleDrop(e,'new'); });
  document.getElementById('drop-new').addEventListener('dragover', e=> e.preventDefault());

  async function createCourse(){
    const name = document.getElementById('course-name').value.trim();
    if(!name) return alert('Nama mata kuliah wajib.');
    const { data, error } = await sb.from('courses').insert({ name }).select().single();
    if(error){ alert('Gagal membuat matkul: '+error.message); return; }
    const courseId = data.id;
    const teks = document.getElementById('initial-question').value.trim();
    const opts = Array.from(document.querySelectorAll('.opt.init')).map(i=>i.value.trim()).filter(Boolean);
    const key = document.getElementById('initial-key').value;
    let gambarUrl = null;
    if(newCourseImage) {
      gambarUrl = await uploadImage(newCourseImage);
    }
    if(teks && opts.length >= 2 && key !== '') {
      const { error: qErr } = await sb.from('questions').insert({ course_id: courseId, teks, opsi: opts, kunci: parseInt(key,10), gambar: gambarUrl });
      if(qErr) console.warn('Initial question error', qErr);
    }
    document.getElementById('course-name').value=''; 
    document.getElementById('initial-question').value='';
    document.querySelectorAll('.opt.init').forEach(i=>i.value=''); 
    document.getElementById('initial-key').value='';
    newCourseImage = null; 
    previewNew.src=''; 
    previewNew.classList.add('hidden'); 
    fileNew.value='';
    await loadCourses();
    alert('Mata kuliah berhasil dibuat.'); 
    showSection('dashboard');
  }
  document.getElementById('create-course').addEventListener('click', createCourse);
  
  function handleFileInput(e,target){
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      if(target === 'new'){ 
        newCourseImage = ev.target.result;
        previewNew.src = newCourseImage; 
        previewNew.classList.remove('hidden');
      }
      else if(target === 'q'){ 
        editing._localImage = ev.target.result;
        document.getElementById('preview-q').src = editing._localImage; 
        document.getElementById('preview-q').classList.remove('hidden');
      }
    };
    reader.readAsDataURL(f);
  }

  function handleDrop(e,target){
    const f = e.dataTransfer.files[0]; 
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      if(target === 'new'){ 
        newCourseImage = ev.target.result;
        previewNew.src=newCourseImage; 
        previewNew.classList.remove('hidden'); 
      }
      else if(target === 'q'){ 
        editing._localImage = ev.target.result;
        document.getElementById('preview-q').src = editing._localImage; 
        document.getElementById('preview-q').classList.remove('hidden');
      }
    }; 
    reader.readAsDataURL(f);
  }

  async function uploadImage(dataUrl){
    if(!dataUrl) return null;
    try{
      const res = await fetch(dataUrl); 
      const blob = await res.blob();
      const filename = `img_${Date.now()}.png`;
      const { data, error } = await sb.storage.from(STORAGE_BUCKET).upload(filename, blob, { cacheControl:'3600', upsert:false });
      if(error){ 
        console.warn('upload error', error.message); 
        return dataUrl;
      }
      const { data: urlData } = sb.storage.from(STORAGE_BUCKET).getPublicUrl(filename);
      return (urlData && urlData.publicUrl) ? urlData.publicUrl : dataUrl;
    }catch(err){ 
      console.warn('upload exception', err); 
      return dataUrl;
    }
  }

  // Manage section
  const selectManage = document.getElementById('select-manage');
  const btnAddQ = document.getElementById('btn-add-q');
  selectManage.addEventListener('change', async ()=> { 
    const nm = selectManage.value; 
    await openManageForCourse(nm); 
    btnAddQ.disabled = !nm; 
  });
  async function openManageForCourse(name){
    const c = courses.find(x=>x.name===name); 
    currentCourse = c||null;
    if(!c){ 
      document.getElementById('questions-list').innerHTML = '<div class="muted">Pilih mata kuliah terlebih dahulu.</div>'; 
      return;
    }
    const { data, error } = await sb.from('questions').select('*').eq('course_id', c.id).order('created_at', { ascending: false });
    if(error){ 
      alert('Gagal ambil soal: '+error.message); 
      return; 
    }
    questions = data || []; 
    renderQuestionList();
  }

  function renderQuestionList(){
    const wrap = document.getElementById('questions-list'); 
    wrap.innerHTML = '';
    if(!questions || questions.length === 0){ 
      wrap.innerHTML = '<div class="muted text-center p-4 card">Belum ada soal.</div>';
      return;
    }
    questions.forEach(q=>{
      const div = document.createElement('div'); 
      div.className = 'p-3 card flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 shadow-md rounded-xl';
      div.innerHTML = `
        <div class="flex-1">
          <div class="font-medium">${escapeHtml(q.teks)}</div>
          <div class="text-xs muted mt-1">${new Date(q.created_at || q.createdAt || Date.now()).toLocaleString()}</div>
          <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
            ${(q.opsi||[]).map((o,idx)=>`<div class="${idx===q.kunci?'bg-emerald-700 text-white':'bg-white/5'} p-2 border rounded text-sm">${String.fromCharCode(65+idx)}. ${escapeHtml(o)}</div>`).join('')}
          </div>
          ${q.gambar? `<img src="${q.gambar}" class="mt-2 max-h-36 rounded" />` : ''}
        </div>
        <div class="flex flex-row sm:flex-col gap-2 w-full sm:w-auto mt-2 sm:mt-0">
          <button data-id="${q.id}" class="edit-q btn-ghost text-sm py-2 px-4">Edit</button>
          <button data-id="${q.id}" class="del-q btn-danger text-sm py-2 px-4">Hapus</button>
        </div>
      `;
      wrap.appendChild(div);
    });

    // bind actions
    wrap.querySelectorAll('.del-q').forEach(b=> b.addEventListener('click', async ()=>{
      if(!confirm('Hapus soal?')) return;
      const id = b.dataset.id; 
      const { error } = await sb.from('questions').delete().eq('id', id);
      if(error) return alert('Gagal hapus: '+error.message);
      await openManageForCourse(currentCourse.name);
    }));
    wrap.querySelectorAll('.edit-q').forEach(b=> b.addEventListener('click', ()=>{
      const id = b.dataset.id; 
      const q = questions.find(x=>x.id===id); 
      if(!q) return;
      editing = JSON.parse(JSON.stringify(q));
      document.getElementById('editor-title').textContent = 'Edit Soal';
      document.getElementById('qe-text').value = editing.teks || '';
      for(let i=0;i<4;i++) document.getElementById('qe-opt-'+i).value = (editing.opsi && editing.opsi[i]) || '';
      document.getElementById('qe-key').value = editing.kunci;
      if(editing.gambar){ 
        document.getElementById('preview-q').src = editing.gambar; 
        document.getElementById('preview-q').classList.remove('hidden'); 
      } else { 
        document.getElementById('preview-q').classList.add('hidden'); 
      }
      sections.editor.classList.remove('hidden'); 
      window.scrollTo({top: document.getElementById('editor-section').offsetTop - 20, behavior:'smooth'});
    }));
  }

  // Add question button
  btnAddQ.addEventListener('click', ()=> {
    if(!currentCourse) return alert('Pilih mata kuliah dulu');
    editing = { id:null, teks:'', opsi:['','','',''], kunci:'', gambar:null, _localImage:null };
    document.getElementById('editor-title').textContent = 'Tambah Soal';
    document.getElementById('qe-text').value = '';
    for(let i=0;i<4;i++) document.getElementById('qe-opt-'+i).value='';
    document.getElementById('qe-key').value='';
    document.getElementById('preview-q').classList.add('hidden');
    document.getElementById('preview-q').src='';
    sections.editor.classList.remove('hidden'); 
    window.scrollTo({top: document.getElementById('editor-section').offsetTop - 20, behavior:'smooth'});
  });

  // editor file handlers
  const fileQ = document.getElementById('file-q'), pickQ = document.getElementById('pick-q'), clearQ = document.getElementById('clear-q'), previewQ = document.getElementById('preview-q');
  pickQ.addEventListener('click', ()=> fileQ.click());
  fileQ.addEventListener('change', (e)=> handleFileInput(e,'q'));
  clearQ.addEventListener('click', ()=> { editing._localImage = null; editing.gambar = null; previewQ.src=''; previewQ.classList.add('hidden'); fileQ.value=''; });
  document.getElementById('drop-q').addEventListener('drop', e=>{ e.preventDefault(); handleDrop(e,'q'); });
  document.getElementById('drop-q').addEventListener('dragover', e=> e.preventDefault());

  // Save question
  document.getElementById('save-q').addEventListener('click', async ()=>{
    const teks = document.getElementById('qe-text').value.trim();
    const opsi = [0,1,2,3].map(i=>document.getElementById('qe-opt-'+i).value.trim()).filter(Boolean);
    const key = document.getElementById('qe-key').value;
    if(!teks || opsi.length < 2 || key === '') return alert('Lengkapi teks, minimal 2 opsi, dan kunci.');
    let gambarToSave = editing._localImage || editing.gambar || null;
    if(editing._localImage) gambarToSave = await uploadImage(editing._localImage);
    if(editing.id){
      const { error } = await sb.from('questions').update({ teks, opsi, kunci: parseInt(key,10), gambar: gambarToSave }).eq('id', editing.id);
      if(error) return alert('Gagal update: '+error.message);
      alert('Soal diperbarui');
    } else {
      const { data, error } = await sb.from('questions').insert({ course_id: currentCourse.id, teks, opsi, kunci: parseInt(key,10), gambar: gambarToSave }).select().single();
      if(error) return alert('Gagal tambah: '+error.message);
      alert('Soal ditambahkan');
    }
    await openManageForCourse(currentCourse.name);
    sections.editor.classList.add('hidden');
  });
  document.getElementById('editor-cancel').addEventListener('click', ()=> sections.editor.classList.add('hidden'));

  // NEW FEATURE: File Upload
  const fileUploadEl = document.getElementById('file-upload');
  const uploadStatusEl = document.getElementById('upload-status');
  fileUploadEl.addEventListener('change', async (e) => {
    if(!currentCourse) {
      alert('Pilih mata kuliah terlebih dahulu untuk mengunggah soal.');
      fileUploadEl.value = '';
      return;
    }
    const file = e.target.files[0];
    if(!file) return;
    uploadStatusEl.textContent = 'Mengunggah dan memproses file...';
    try {
      const text = await file.text();
      const questionsToInsert = parseQuestionsFromFile(text);
      if (questionsToInsert.length > 0) {
        const { error } = await sb.from('questions').insert(questionsToInsert);
        if (error) {
          uploadStatusEl.textContent = `Gagal mengunggah soal: ${error.message}`;
          alert(`Gagal mengunggah soal: ${error.message}`);
        } else {
          uploadStatusEl.textContent = `Berhasil mengunggah ${questionsToInsert.length} soal.`;
          await openManageForCourse(currentCourse.name);
          alert(`Berhasil mengunggah ${questionsToInsert.length} soal.`);
        }
      } else {
        uploadStatusEl.textContent = 'Tidak ada soal yang valid ditemukan di file.';
      }
    } catch (err) {
      uploadStatusEl.textContent = `Error: ${err.message}`;
      alert(`Terjadi kesalahan saat memproses file: ${err.message}`);
    } finally {
      fileUploadEl.value = ''; // Reset file input
    }
  });

  function parseQuestionsFromFile(text) {
    const lines = text.split('\n').map(line => line.trim()).filter(Boolean);
    const questions = [];
    let currentQ = null;
    lines.forEach(line => {
      if (line.startsWith('Q:')) {
        if (currentQ) {
          questions.push(currentQ);
        }
        currentQ = { course_id: currentCourse.id, teks: line.substring(2).trim(), opsi: [], kunci: null };
      } else if (line.startsWith('A:')) {
        if (currentQ) currentQ.opsi.push(line.substring(2).trim());
      } else if (line.startsWith('B:')) {
        if (currentQ) currentQ.opsi.push(line.substring(2).trim());
      } else if (line.startsWith('C:')) {
        if (currentQ) currentQ.opsi.push(line.substring(2).trim());
      } else if (line.startsWith('D:')) {
        if (currentQ) currentQ.opsi.push(line.substring(2).trim());
      } else if (line.startsWith('K:')) {
        const keyChar = line.substring(2).trim().toUpperCase();
        if (currentQ) {
          const keyMap = {'A': 0, 'B': 1, 'C': 2, 'D': 3};
          currentQ.kunci = keyMap[keyChar] !== undefined ? keyMap[keyChar] : null;
        }
      }
    });
    if (currentQ && currentQ.teks && currentQ.opsi.length >= 2 && currentQ.kunci !== null) {
      questions.push(currentQ);
    }
    return questions.filter(q => q.teks && q.opsi.length >= 2 && q.kunci !== null);
  }

  // EXAM: show all and scroll-spy + mobile numbers
  const sidebarEl = document.getElementById('exam-sidebar');
  const gridEl = document.getElementById('exam-grid');
  const mobileNumbersWrap = document.querySelector('#mobile-numbers .grid');
  const progressBar = document.getElementById('exam-progress');
  const progressText = document.getElementById('progress-text');
  const startExamBtn = document.getElementById('start-exam');
  const endExamBtn = document.getElementById('end-exam');
  const examScoreDisplay = document.getElementById('exam-score-display');
  let examState = { active: false, finished: false, items: [], answers: {}, refs: {}, answeredCount: 0 };
  
  // New event listener for endExam button
  endExamBtn.addEventListener('click', endExam);

  async function startExam(){
    const cname = document.getElementById('select-exam').value;
    const course = cname ? courses.find(x=>x.name===cname) : courses[0];
    if(!course) {
      alert('Belum ada mata kuliah untuk memulai ujian.');
      showSection('dashboard');
      return;
    }
    const count = 50;
    const { data } = await sb.from('questions').select('*').eq('course_id', course.id);
    if(!data || data.length === 0) {
      alert('Belum ada soal di mata kuliah ini.');
      showSection('manage');
      return;
    }
    // Shuffle and limit to 50
    const arr = data.sort(() => Math.random() - 0.5).slice(0, Math.min(count, data.length));
    examState.active = true;
    examState.finished = false;
    examState.items = arr;
    examState.answers = {};
    examState.refs = {};
    examState.answeredCount = 0;
    
    // UI states
    startExamBtn.classList.add('hidden');
    endExamBtn.classList.remove('hidden');
    document.getElementById('select-exam').disabled = true;
    examScoreDisplay.classList.add('hidden');
    renderExamAll();
    setTimeout(()=> { document.getElementById('exam-grid').scrollTo({ top:0, behavior:'smooth' }); }, 80);
  }
  
  async function endExam(){
    examState.finished = true;
    let correctAnswers = 0;
    
    // Iterate and check answers
    examState.items.forEach(q => {
      const userAnswer = examState.answers[q.id];
      if (userAnswer === q.kunci) {
        correctAnswers++;
      }
      updateQuestionVisual(q.id, true); // Show correct answer and user's answer
    });
    
    const totalQuestions = examState.items.length;
    const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
    // Display score summary
    examScoreDisplay.classList.remove('hidden');
    examScoreDisplay.innerHTML = `
      <h3 class="text-xl font-bold">Hasil Ujian</h3>
      <p class="text-sm mt-2">Anda menjawab **${correctAnswers}** dari **${totalQuestions}** pertanyaan dengan benar.</p>
      <p class="text-3xl font-extrabold mt-2">Skor: ${score}%</p>
    `;
    
    startExamBtn.classList.remove('hidden');
    endExamBtn.classList.add('hidden');
    document.getElementById('select-exam').disabled = false;
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Quiz rendering and state management
  function renderExamAll() {
    gridEl.innerHTML = '';
    sidebarEl.innerHTML = '';
    mobileNumbersWrap.innerHTML = '';
    
    examState.items.forEach((q, i) => {
      // Main card
      const card = document.createElement('div');
      card.id = 'q-' + q.id;
      card.className = 'card p-4 shadow-lg rounded-xl';
      card.innerHTML = `
        <div class="font-medium text-lg">Soal #${i + 1}</div>
        <div class="mt-2 text-base leading-relaxed">${escapeHtml(q.teks)}</div>
        ${q.gambar ? `<img src="${q.gambar}" class="mt-4 max-h-48 rounded-lg shadow-md" />` : ''}
        <div class="flex flex-col gap-2 mt-4" id="options-${q.id}">
          ${(q.opsi || []).map((o, idx) => `
            <button
              data-q-id="${q.id}"
              data-idx="${idx}"
              class="option-btn text-left p-3 border rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
            >
              <span class="font-semibold">${String.fromCharCode(65 + idx)}.</span> ${escapeHtml(o)}
            </button>
          `).join('')}
        </div>
      `;
      gridEl.appendChild(card);
      examState.refs[q.id] = card;
      
      // Sidebar button
      const navBtn = document.createElement('button');
      navBtn.className = 'px-2 py-1 rounded w-full text-center transition-colors';
      navBtn.textContent = i + 1;
      navBtn.addEventListener('click', () => {
        document.getElementById('q-' + q.id).scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      sidebarEl.appendChild(navBtn);
      
      // Mobile number button
      const mobileBtn = document.createElement('button');
      mobileBtn.className = 'px-3 py-2 rounded-md font-semibold text-center transition-colors bg-white/5 hover:bg-white/10';
      mobileBtn.textContent = i + 1;
      mobileBtn.addEventListener('click', () => {
          document.getElementById('q-' + q.id).scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      mobileNumbersWrap.appendChild(mobileBtn);
    });
    
    bindExamActions();
    updateProgress();
  }

  function bindExamActions(){
    document.querySelectorAll('.option-btn').forEach(b => {
      b.addEventListener('click', (e) => {
        const qid = e.target.dataset.qId || e.target.closest('button').dataset.qId;
        const optIdx = parseInt(e.target.dataset.idx || e.target.closest('button').dataset.idx, 10);
        
        if (examState.answers[qid] === undefined) {
          examState.answeredCount++;
        }
        
        examState.answers[qid] = optIdx;
        updateQuestionVisual(qid);
        updateProgress();
      });
    });
    
    // Add event listeners for mobile numbers, to prevent scroll on click
    document.querySelectorAll('#mobile-numbers button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(e.target.textContent) - 1;
        const qid = examState.items[index].id;
        document.getElementById('q-' + qid).scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });
  }

  function updateQuestionVisual(qid, showAnswer = false){
    const card = examState.refs[qid];
    const question = examState.items.find(q=>q.id===qid);
    if (!card || !question) return;

    const navBtn = document.querySelector(`#exam-sidebar button:nth-child(${examState.items.findIndex(q => q.id === qid) + 1})`);
    const mobileBtn = document.querySelector(`#mobile-numbers .grid button:nth-child(${examState.items.findIndex(q => q.id === qid) + 1})`);
    
    // Reset background colors
    card.querySelectorAll('.option-btn').forEach(btn => {
      btn.classList.remove('bg-emerald-700', 'bg-rose-700', 'bg-indigo-700');
      btn.classList.add('bg-white/5', 'hover:bg-white/10');
    });

    if (showAnswer) {
      const userAnswer = examState.answers[qid];
      const correctKey = question.kunci;
      
      card.querySelectorAll('.option-btn').forEach((btn, idx) => {
        btn.disabled = true;
        if (idx === correctKey) {
          btn.classList.remove('bg-white/5', 'hover:bg-white/10');
          btn.classList.add('bg-emerald-700');
        } else if (idx === userAnswer && userAnswer !== correctKey) {
          btn.classList.remove('bg-white/5', 'hover:bg-white/10');
          btn.classList.add('bg-rose-700');
        }
      });
      
      if (userAnswer === correctKey) {
        navBtn.classList.remove('bg-white/10', 'bg-rose-500', 'bg-indigo-500');
        navBtn.classList.add('bg-emerald-500');
        if(mobileBtn){ mobileBtn.classList.remove('bg-white/10', 'bg-rose-500', 'bg-indigo-500'); mobileBtn.classList.add('bg-emerald-500'); }
      } else {
        navBtn.classList.remove('bg-white/10', 'bg-emerald-500', 'bg-indigo-500');
        navBtn.classList.add('bg-rose-500');
        if(mobileBtn){ mobileBtn.classList.remove('bg-white/10', 'bg-emerald-500', 'bg-indigo-500'); mobileBtn.classList.add('bg-rose-500'); }
      }
      
    } else {
      const selectedIndex = examState.answers[qid];
      if (selectedIndex !== undefined) {
        const selectedBtn = card.querySelector(`.option-btn[data-idx="${selectedIndex}"]`);
        if (selectedBtn) {
          selectedBtn.classList.remove('bg-white/5', 'hover:bg-white/10');
          selectedBtn.classList.add('bg-indigo-700');
        }
        
        navBtn.classList.remove('bg-white/5', 'bg-rose-500');
        navBtn.classList.add('bg-indigo-500');
        if(mobileBtn){ mobileBtn.classList.remove('bg-white/5', 'bg-rose-500'); mobileBtn.classList.add('bg-indigo-500'); }

      } else {
          navBtn.classList.remove('bg-indigo-500', 'bg-rose-500');
          navBtn.classList.add('bg-white/5');
          if(mobileBtn){ mobileBtn.classList.remove('bg-indigo-500', 'bg-rose-500'); mobileBtn.classList.add('bg-white/5'); }
      }
    }
  }

  function updateProgress(){
    const total = examState.items.length;
    const answered = examState.answeredCount || Object.keys(examState.answers).length;
    const pct = total ? Math.round((answered/total)*100) : 0;
    progressBar.style.width = pct + '%';
    progressText.textContent = `${answered} / ${total} dijawab`;
  }

  function populateSelects(){
    const selManage = document.getElementById('select-manage');
    const selExam = document.getElementById('select-exam');
    const cur1 = selManage.value, cur2 = selExam.value;
    [selManage, selExam].forEach(s=>{
      s.innerHTML = '<option value="">— Pilih Mata Kuliah —</option>';
      courses.forEach(c => { 
        const o = document.createElement('option'); 
        o.value = c.name; 
        o.textContent = c.name; 
        s.appendChild(o); 
      });
    });
    document.getElementById('btn-add-q').disabled = !document.getElementById('select-manage').value;
    document.getElementById('select-manage').value = cur1 || '';
    document.getElementById('select-exam').value = cur2 || '';
  }

  loadCourses();
</script>
</body>
</html>
